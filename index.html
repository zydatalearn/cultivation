<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>修仙模拟器 v5.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 金色主题 - 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #FFD700, #FFEC8B, #FFFACD);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0;
            padding: 10px;
            position: relative;
        }
        
        .game-wrapper {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1), 
                        0 0 30px rgba(218, 165, 32, 0.3);
            position: relative;
            overflow: hidden;
            border: 3px solid #FFD700;
            width: 100%;
        }
        
        .game-wrapper::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, #FFD700, #FFEC8B, #FFFACD);
            z-index: 10;
        }
        
        header {
            text-align: center;
            padding: 15px;
            margin-bottom: 0;
            position: relative;
            background: linear-gradient(to bottom, rgba(218, 165, 32, 0.2), transparent);
        }
        
        h1 {
            font-size: 1.8rem;
            background: linear-gradient(to right, #B8860B, #DAA520, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
            margin-bottom: 0;
            font-weight: 800;
            position: relative;
            display: inline-block;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0 10px;
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: #B8860B;
            font-style: italic;
            margin-top: 2px;
            text-shadow: 0 0 8px rgba(218, 165, 32, 0.1);
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 12px;
            padding: 0 10px;
        }
        
        @media (min-width: 992px) {
            .game-container {
                flex-direction: row;
            }
        }
        
        .main-content {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .side-content {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .panel {
            background: rgba(255, 253, 231, 0.9);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
            border: 2px solid #FFD700;
            position: relative;
            overflow: hidden;
        }
        
        .panel::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #FFD700, #FFEC8B);
            z-index: 1;
        }
        
        .panel-title {
            font-size: 1.1rem;
            color: #B8860B;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
            padding-bottom: 6px;
            border-bottom: 2px solid rgba(218, 165, 32, 0.3);
        }
        
        .panel-title i {
            color: #DAA520;
            font-size: 1rem;
        }
        
        /* 选项卡样式 */
        .tab-container {
            display: flex;
            border-bottom: 2px solid rgba(218, 165, 32, 0.2);
            margin-bottom: 12px;
            flex-wrap: wrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            color: #B8860B;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 0.85rem;
        }
        
        .tab.active {
            color: #8B6914;
            border-bottom-color: #DAA520;
            background: rgba(218, 165, 32, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 天赋卡片 - 缩小版 */
        .buff-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        @media (min-width: 768px) {
            .buff-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 992px) {
            .buff-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .buff-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            padding: 8px;
            width: 100%;
            border: 2px solid #FFD700;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 90px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .buff-card:hover, .buff-card:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(218, 165, 32, 0.2);
            border-color: #B8860B;
        }
        
        .buff-card.selected {
            border-width: 2px;
            box-shadow: 0 0 15px rgba(184, 134, 11, 0.4);
            background: rgba(218, 165, 32, 0.1);
        }
        
        .buff-card.common {
            border-color: #777;
        }
        
        .buff-card.rare {
            border-color: #4682b4;
        }
        
        .buff-card.epic {
            border-color: #9370db;
        }
        
        .buff-card.legendary {
            border-color: #daa520;
            animation: pulse 2s infinite;
        }
        
        .buff-card.mythic {
            border-color: #ff4500;
            animation: pulse-glow 1.5s infinite alternate;
        }
        
        .buff-rarity {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: bold;
            color: white;
        }
        
        .common .buff-rarity {
            background: linear-gradient(135deg, #666, #888);
        }
        
        .rare .buff-rarity {
            background: linear-gradient(135deg, #4682b4, #5f9ea0);
        }
        
        .epic .buff-rarity {
            background: linear-gradient(135deg, #9370db, #ba55d3);
        }
        
        .legendary .buff-rarity {
            background: linear-gradient(135deg, #daa520, #ff8c00);
        }
        
        .mythic .buff-rarity {
            background: linear-gradient(135deg, #ff4500, #ff6347);
        }
        
        .buff-name {
            font-size: 0.8rem;
            margin-bottom: 4px;
            color: #333;
            font-weight: bold;
            padding-right: 45px;
            line-height: 1.2;
        }
        
        .buff-desc {
            font-size: 0.7rem;
            color: #666;
            min-height: 35px;
            line-height: 1.3;
        }
        
        .buff-select {
            margin-top: 4px;
            text-align: center;
            color: #666;
            font-weight: bold;
            display: none;
            font-size: 0.7rem;
        }
        
        .buff-card.selected .buff-select {
            display: block;
        }
        
        .lock-icon {
            position: absolute;
            top: 5px;
            left: 5px;
            color: #999;
            cursor: pointer;
            font-size: 0.75rem;
            z-index: 2;
            background: rgba(255, 255, 255, 0.9);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(218, 165, 32, 0.5);
            -webkit-tap-highlight-color: transparent;
        }
        
        .lock-icon.locked {
            color: #666;
            background: rgba(102, 102, 102, 0.1);
            border-color: #666;
        }
        
        /* 按钮样式 */
        .btn {
            background: linear-gradient(to right, #DAA520, #FFD700);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 6px 20px rgba(218, 165, 32, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
            border: 1px solid rgba(184, 134, 11, 0.5);
            width: 100%;
            margin-bottom: 8px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #FFD700, #DAA520);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(218, 165, 32, 0.4);
            color: white;
        }
        
        .btn:hover::before, .btn:active::before {
            opacity: 1;
        }
        
        .btn:disabled {
            background: #ccc;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: #aaa;
        }
        
        .btn:disabled:hover::before {
            opacity: 0;
        }
        
        /* 灵力显示 */
        .spirit-power {
            font-size: 1.4rem;
            color: #B8860B;
            text-align: center;
            margin: 15px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .spirit-icon {
            display: inline-block;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #DAA520, #FFD700, #FFEC8B);
            border-radius: 50%;
            position: relative;
            animation: float 3s ease-in-out infinite;
        }
        
        .spirit-icon::after {
            content: "⚡";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
        }
        
        .spirit-per-minute {
            font-size: 0.8rem;
            color: #B8860B;
            background: rgba(218, 165, 32, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            margin-top: 6px;
            border: 1px solid rgba(184, 134, 11, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            margin-bottom: 0;
        }
        
        .cultivate-btn {
            flex: 1;
            text-align: center;
            padding: 8px;
            min-width: auto;
        }
        
        /* 战斗区域 */
        .monster-battle {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 12px;
            border: 2px solid #FFD700;
            position: relative;
        }
        
        .monster-name {
            font-size: 1.2rem;
            color: #cc3333;
            text-align: center;
            margin-bottom: 8px;
            font-weight: bold;
            text-shadow: 0 2px 5px rgba(204, 51, 51, 0.1);
        }
        
        .monster-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .stat {
            text-align: center;
            padding: 8px;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 6px;
            min-width: auto;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(218, 165, 32, 0.5);
        }
        
        .stat-value {
            font-size: 1rem;
            color: #B8860B;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #8B6914;
        }
        
        .battle-info {
            height: 100px;
            overflow-y: auto;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 6px;
            padding: 10px;
            margin-top: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85rem;
            border: 1px solid rgba(218, 165, 32, 0.5);
            text-align: left;
            line-height: 1.4;
        }
        
        /* 进度条 */
        .progress-container {
            margin: 15px 0;
            position: relative;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #B8860B;
        }
        
        .progress-bar {
            height: 20px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(218, 165, 32, 0.5);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #DAA520, #FFD700);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .refresh-counter {
            background: rgba(218, 165, 32, 0.2);
            padding: 8px 12px;
            border-radius: 15px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            border: 1px solid rgba(184, 134, 11, 0.3);
            font-size: 0.9rem;
            color: #8B6914;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            margin-top: 12px;
            color: #8B6914;
            font-size: 0.8rem;
            border-top: 1px solid rgba(218, 165, 32, 0.3);
            background: rgba(255, 253, 231, 0.9);
        }
        
        .cultivation-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(218, 165, 32, 0.1);
            padding: 6px 10px;
            border-radius: 15px;
            color: #8B6914;
            font-size: 0.8rem;
            border: 1px solid rgba(184, 134, 11, 0.2);
        }
        
        .info-value {
            color: #B8860B;
            font-weight: bold;
        }
        
        .cultivation-stage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding: 10px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .stage-info {
            text-align: center;
        }
        
        .stage-name {
            font-size: 1rem;
            color: #B8860B;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .stage-level {
            font-size: 0.9rem;
            color: #8B6914;
        }
        
        /* 人物属性卡片 */
        .character-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .stat-card {
            flex: 1;
            min-width: auto;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(218, 165, 32, 0.5);
        }
        
        .stat-card-title {
            font-size: 0.85rem;
            color: #8B6914;
            margin-bottom: 6px;
        }
        
        .stat-card-value {
            font-size: 1.1rem;
            color: #B8860B;
            font-weight: bold;
        }
        
        .stat-card-add {
            margin-top: 6px;
            padding: 5px 10px;
            background: linear-gradient(to right, #DAA520, #FFD700);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }
        
        .stat-card-add:hover {
            background: linear-gradient(to right, #FFD700, #DAA520);
        }
        
        /* 怪物选择 */
        .monster-selection {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            margin-top: 10px;
            padding-bottom: 6px;
            scrollbar-width: thin;
            -webkit-overflow-scrolling: touch;
        }
        
        .monster-option {
            flex: 0 0 auto;
            min-width: 90px;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid rgba(218, 165, 32, 0.7);
            transition: all 0.3s ease;
            font-size: 0.8rem;
            -webkit-tap-highlight-color: transparent;
        }
        
        .monster-option:hover, .monster-option:active {
            border-color: #B8860B;
            transform: translateY(-3px);
        }
        
        .monster-option.selected {
            border-color: #8B6914;
            background: rgba(218, 165, 32, 0.2);
        }
        
        .monster-level {
            font-size: 0.85rem;
            color: #B8860B;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .monster-reward {
            font-size: 0.75rem;
            color: #8B6914;
        }
        
        /* 复活界面 */
        .resurrect-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 253, 231, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            border-radius: 12px;
        }
        
        .resurrect-title {
            font-size: 1.2rem;
            color: #cc3333;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .resurrect-timer {
            font-size: 1.6rem;
            font-weight: bold;
            color: #B8860B;
            text-align: center;
        }
        
        /* 属性加点 */
        .attribute-points {
            margin-top: 12px;
            padding: 12px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .attribute-title {
            font-size: 1rem;
            color: #B8860B;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .attribute-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .attribute-item {
            padding: 10px;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .attribute-name {
            font-weight: bold;
            color: #B8860B;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        
        .attribute-value {
            color: #B8860B;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .attribute-cost {
            color: #8B6914;
            font-size: 0.8rem;
            margin-top: 4px;
        }
        
        .attribute-add {
            margin-top: 6px;
            padding: 6px 10px;
            background: linear-gradient(to right, #DAA520, #FFD700);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.8rem;
            cursor: pointer;
            width: 100%;
        }
        
        .crit-text {
            animation: critAnimation 0.5s ease-in-out;
            color: #cc3333;
            font-weight: bold;
        }
        
        .gold-border {
            border: 2px solid #FFD700;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            background: rgba(218, 165, 32, 0.05);
        }
        
        .gold-text {
            color: #8B6914;
            font-weight: bold;
        }
        
        /* 特殊属性 */
        .special-attributes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        
        .special-attribute {
            background: rgba(255, 253, 231, 0.9);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .special-name {
            font-size: 0.8rem;
            color: #8B6914;
            margin-bottom: 5px;
        }
        
        .special-value {
            font-size: 0.9rem;
            color: #B8860B;
            font-weight: bold;
        }
        
        /* 装备系统样式 - 优化后的布局 */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        
        .equipment-slot {
            background: rgba(255, 253, 231, 0.7);
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            border: 2px dashed rgba(184, 134, 11, 0.5);
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .equipment-slot:hover, .equipment-slot:active {
            border-color: #B8860B;
            background: rgba(184, 134, 11, 0.1);
        }
        
        .equipment-slot.filled {
            border: 2px solid #8B6914;
            background: rgba(218, 165, 32, 0.1);
        }
        
        .equipment-icon {
            font-size: 1.6rem;
            color: #B8860B;
            margin-bottom: 6px;
        }
        
        .equipment-name {
            font-size: 0.8rem;
            color: #333;
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        .equipment-stats {
            font-size: 0.7rem;
            color: #666;
        }
        
        .inventory-container {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(255, 253, 231, 0.7);
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        .inventory-title {
            color: #B8860B;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        
        .inventory-item {
            background: rgba(248, 240, 200, 0.9);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(218, 165, 32, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        .inventory-item:hover, .inventory-item:active {
            border-color: #B8860B;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(218, 165, 32, 0.2);
        }
        
        .inventory-item.selected {
            border-color: #8B6914;
            background: rgba(218, 165, 32, 0.2);
        }
        
        .item-rarity {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.65rem;
            padding: 1px 5px;
            border-radius: 6px;
            font-weight: bold;
            color: white;
        }
        
        .item-name {
            color: #333;
            font-size: 0.75rem;
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        .item-stats {
            color: #666;
            font-size: 0.7rem;
            margin-bottom: 2px;
        }
        
        .item-type {
            color: #8B6914;
            font-size: 0.65rem;
        }
        
        .item-level {
            color: #8B6914;
            font-size: 0.65rem;
            margin-top: 2px;
        }
        
        .equipment-details {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(218, 165, 32, 0.3);
            display: none;
        }
        
        .equipment-details.show {
            display: block;
        }
        
        .equipment-details-title {
            color: #B8860B;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .equipment-details-content {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .monster-scroll {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding-bottom: 6px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* 自动战斗按钮 */
        .auto-battle-btn {
            background: linear-gradient(to right, #2e8b57, #3cb371);
            color: white;
        }
        
        .auto-battle-btn.active {
            background: linear-gradient(to right, #cc3333, #ff4500);
            color: white;
        }
        
        /* 移动端底部导航 */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 253, 231, 0.95);
            border-top: 2px solid #FFD700;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: #8B6914;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .nav-item.active {
            background: rgba(218, 165, 32, 0.2);
            color: #8B6914;
        }
        
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        /* 修仙背景装饰 */
        .taoist-symbol {
            position: absolute;
            opacity: 0.05;
            font-size: 150px;
            color: #DAA520;
            z-index: -1;
            pointer-events: none;
        }
        
        .symbol-1 {
            top: 40px;
            left: 20px;
            transform: rotate(15deg);
        }
        
        .symbol-2 {
            bottom: 40px;
            right: 20px;
            transform: rotate(-15deg);
        }
        
        /* 通知消息 */
        .notification {
            position: fixed;
            top: 15px;
            left: 10px;
            right: 10px;
            background: rgba(255, 253, 231, 0.95);
            border: 1px solid #FFD700;
            border-radius: 8px;
            padding: 12px 15px;
            max-width: 100%;
            transform: translateY(-150%);
            transition: transform 0.4s ease;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .notification.show {
            transform: translateY(0);
        }
        
        .notification-title {
            color: #B8860B;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .notification-content {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #666;
        }
        
        /* 动画效果 */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(218, 165, 32, 0.4); }
            70% { box-shadow: 0 0 0 12px rgba(218, 165, 32, 0); }
            100% { box-shadow: 0 0 0 0 rgba(218, 165, 32, 0); }
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px rgba(255, 69, 0, 0.4); }
            100% { box-shadow: 0 0 20px rgba(255, 69, 0, 0.8); }
        }
        
        @keyframes critAnimation {
            0% { transform: scale(1); text-shadow: 0 0 0 rgba(204, 51, 51, 0); }
            50% { transform: scale(1.5); text-shadow: 0 0 20px rgba(204, 51, 51, 0.5); }
            100% { transform: scale(1); text-shadow: 0 0 0 rgba(204, 51, 51, 0); }
        }
        
        @keyframes level-up {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        
        /* 加载动画 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 253, 231, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading.show {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(218, 165, 32, 0.2);
            border-top: 4px solid #8B6914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 存档提示 */
        .save-notification {
            position: fixed;
            bottom: 15px;
            left: 15px;
            background: rgba(184, 134, 11, 0.1);
            border: 1px solid #B8860B;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            color: #8B6914;
            z-index: 999;
            display: none;
        }
        
        .save-notification.show {
            display: block;
            animation: fadeOut 2s ease-in-out 1s forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        
        /* 自动回收设置 */
        .auto-recycle-settings {
            margin-top: 12px;
            padding: 12px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .auto-recycle-title {
            color: #B8860B;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .recycle-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        .recycle-option {
            padding: 8px;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .recycle-label {
            font-size: 0.85rem;
            color: #B8860B;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .recycle-select {
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid rgba(218, 165, 32, 0.5);
            background: rgba(255, 253, 231, 0.9);
            font-size: 0.85rem;
            color: #333;
        }
        
        /* 移动端优化 */
        @media (max-width: 767px) {
            .game-wrapper {
                border-radius: 10px;
                margin-bottom: 60px;
            }
            
            .panel {
                padding: 12px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 0.95rem;
            }
            
            .monster-option {
                min-width: 100px;
                padding: 12px;
            }
            
            .stat {
                padding: 10px;
            }
            
            .buff-card {
                min-height: 85px;
                padding: 8px;
            }
            
            .equipment-grid {
                gap: 8px;
            }
            
            .equipment-slot {
                min-height: 80px;
                padding: 10px 6px;
            }
            
            .inventory-grid {
                grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
            }
        }
        
        /* 触摸反馈 */
        .touch-feedback {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            background: rgba(218, 165, 32, 0.1);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        
        .btn:active .touch-feedback,
        .buff-card:active .touch-feedback,
        .monster-option:active .touch-feedback,
        .inventory-item:active .touch-feedback {
            opacity: 1;
        }
        
        /* 长按提示 */
        .long-press-hint {
            position: absolute;
            bottom: -18px;
            left: 0;
            right: 0;
            font-size: 0.65rem;
            color: #aaa;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .equipment-slot:hover .long-press-hint,
        .inventory-item:hover .long-press-hint {
            opacity: 1;
        }
        
        /* 选中天赋容器 */
        .selected-buffs-container {
            margin-top: 12px;
            padding: 12px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .selected-buffs-title {
            color: #B8860B;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .selected-buffs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        /* 战斗状态指示器 */
        .battle-status {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .status-item {
            text-align: center;
        }
        
        .status-label {
            font-size: 0.75rem;
            color: #8B6914;
        }
        
        .status-value {
            font-size: 0.9rem;
            color: #B8860B;
            font-weight: bold;
        }
        
        /* 存档管理 */
        .save-manager {
            margin-top: 12px;
            padding: 12px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .save-manager-title {
            color: #B8860B;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .save-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
        }
        
        /* 重置游戏按钮 */
        .reset-btn {
            background: linear-gradient(to right, #cc3333, #ff4500);
            color: white;
        }
        
        /* 当前境界显示 */
        .current-stage-display {
            display: inline-block;
            background: rgba(218, 165, 32, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            color: #8B6914;
            font-weight: bold;
            margin-left: 10px;
        }
        
        /* 境界修炼进度 */
        .cultivation-progress-container {
            margin: 15px 0;
            position: relative;
        }
        
        .cultivation-progress-bar {
            height: 20px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(218, 165, 32, 0.5);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.05);
        }
        
        .cultivation-progress-fill {
            height: 100%;
            background: linear-gradient(to right, #9370db, #ba55d3);
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .cultivation-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* 装备属性展示 */
        .equipment-bonus-display {
            margin-top: 12px;
            padding: 12px;
            background: rgba(184, 134, 11, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(184, 134, 11, 0.3);
        }
        
        .equipment-bonus-title {
            color: #B8860B;
            margin-bottom: 8px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .equipment-bonus-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .equipment-bonus-item {
            background: rgba(255, 253, 231, 0.9);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border: 1px solid rgba(184, 134, 11, 0.3);
        }
        
        .equipment-bonus-name {
            font-size: 0.8rem;
            color: #8B6914;
            margin-bottom: 4px;
        }
        
        .equipment-bonus-value {
            font-size: 0.9rem;
            color: #B8860B;
            font-weight: bold;
        }
        
        /* 世界BOSS样式 */
        .world-boss-info {
            background: rgba(255, 69, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid rgba(255, 69, 0, 0.3);
        }
        
        .boss-name {
            font-size: 1.4rem;
            color: #ff4500;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 69, 0, 0.3);
        }
        
        .boss-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .boss-stat {
            text-align: center;
            padding: 8px;
            background: rgba(248, 240, 200, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(255, 69, 0, 0.3);
        }
        
        .boss-stat-value {
            font-size: 1rem;
            color: #cc3333;
            font-weight: bold;
        }
        
        .boss-stat-label {
            font-size: 0.8rem;
            color: #8B6914;
        }
        
        .boss-daily-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 69, 0, 0.1);
            border-radius: 6px;
        }
        
        .boss-daily-item {
            text-align: center;
        }
        
        .boss-daily-label {
            font-size: 0.75rem;
            color: #8B6914;
        }
        
        .boss-daily-value {
            font-size: 0.9rem;
            color: #cc3333;
            font-weight: bold;
        }
        
        .boss-damage-display {
            margin-top: 10px;
            padding: 8px;
            background: rgba(248, 240, 200, 0.9);
            border-radius: 6px;
            text-align: center;
        }
        
        .boss-damage-label {
            font-size: 0.85rem;
            color: #8B6914;
        }
        
        .boss-damage-value {
            font-size: 1.1rem;
            color: #cc3333;
            font-weight: bold;
        }
        
        /* 伤害奖励阶段 */
        .boss-reward-stages {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 253, 231, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .reward-stage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            border: 1px solid rgba(218, 165, 32, 0.3);
        }
        
        .reward-stage.claimed {
            background: rgba(218, 165, 32, 0.3);
            opacity: 0.7;
        }
        
        .reward-stage.claimable {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }
        
        .stage-damage {
            font-weight: bold;
            color: #B8860B;
        }
        
        .stage-reward {
            color: #2e8b57;
            font-weight: bold;
        }
        
        .stage-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background: #ccc;
            color: white;
        }
        
        .stage-status.claimable {
            background: #2e8b57;
        }
        
        .stage-status.claimed {
            background: #999;
        }
        
        /* 连击伤害显示优化 */
        .combo-hit {
            display: block;
            margin-bottom: 2px;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(218, 165, 32, 0.1);
        }
        
        .combo-hit.crit {
            background: rgba(204, 51, 51, 0.1);
            color: #cc3333;
            font-weight: bold;
        }
        
        /* 体质加成显示 */
        .constitution-bonus-display {
            margin-top: 8px;
            padding: 8px;
            background: rgba(184, 134, 11, 0.1);
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
            color: #8B6914;
        }
        
        .constitution-bonus-active {
            background: rgba(184, 134, 11, 0.2);
            border: 1px solid rgba(184, 134, 11, 0.5);
            color: #8B6914;
            font-weight: bold;
        }
        
        /* 境界加成显示 */
        .stage-bonus-display {
            margin-top: 8px;
            padding: 8px;
            background: rgba(218, 165, 32, 0.1);
            border-radius: 6px;
            text-align: center;
            font-size: 0.85rem;
            color: #8B6914;
        }
        
        .stage-bonus-active {
            background: rgba(218, 165, 32, 0.2);
            border: 1px solid rgba(218, 165, 32, 0.5);
            color: #8B6914;
            font-weight: bold;
        }
        
        .damage-leaderboard {
            display: none;
        }
        
        .leaderboard-entry {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 加载动画 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div style="color: #8B6914; font-size: 1rem;">加载修仙世界...</div>
    </div>
    
    <!-- 存档提示 -->
    <div class="save-notification" id="save-notification">
        <i class="fas fa-save"></i> 游戏已自动保存
    </div>
    
    <!-- 通知消息 -->
    <div class="notification" id="notification">
        <div class="notification-title"><i class="fas fa-info-circle"></i> <span id="notification-title">系统提示</span></div>
        <div class="notification-content" id="notification-content">请选择两个天赋开始修仙之旅</div>
    </div>
    
    <div class="taoist-symbol symbol-1">☯</div>
    <div class="taoist-symbol symbol-2">☯</div>
    
    <div class="container">
        <div class="game-wrapper">
            <header>
                <h1>修仙模拟器 v5.0</h1>
                <p class="subtitle">炼气化神 · 炼神还虚 · 炼虚合道 · 渡劫飞升</p>
            </header>
            
            <div class="game-container">
                <div class="main-content">
                    <!-- 天赋选择面板 -->
                    <div class="panel" id="talent-panel">
                        <div class="tab-container">
                            <div class="tab active" data-tab="talents">天赋选择</div>
                            <div class="tab" data-tab="equipment">装备系统</div>
                            <div class="tab" data-tab="worldboss">世界BOSS</div>
                            <div class="tab" data-tab="recycle">自动回收</div>
                            <div class="tab" data-tab="saves">存档管理</div>
                        </div>
                        
                        <!-- 天赋选择内容 -->
                        <div class="tab-content active" id="talents-content">
                            <h2 class="panel-title"><i class="fas fa-magic"></i> 开局天赋</h2>
                            <p style="font-size: 0.85rem; color: #8B6914; margin-bottom: 8px;">请从以下天赋中选择两个，刷新次数: <span id="refresh-count">10</span> 次</p>
                            
                            <div class="buff-container" id="buff-container">
                                <!-- Buffs will be generated here -->
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn" id="refresh-btn"><i class="fas fa-sync-alt"></i> 刷新天赋</button>
                                <button class="btn" id="start-btn" disabled><i class="fas fa-play"></i> 开始修仙</button>
                                <button class="btn reset-btn" id="reset-game-btn"><i class="fas fa-redo"></i> 重置游戏</button>
                            </div>
                            
                            <div class="refresh-counter">
                                <i class="fas fa-redo"></i> 剩余刷新次数: <span id="refresh-counter">10</span>次
                            </div>
                            
                            <div class="cultivation-stage">
                                <div class="stage-info">
                                    <div class="stage-name">已选天赋</div>
                                    <div class="stage-level"><span id="selected-buffs-count">0</span>/2</div>
                                </div>
                                <div class="stage-info">
                                    <div class="stage-name">初始境界</div>
                                    <div class="stage-level">炼气初期</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 装备系统内容 - 优化版 -->
                        <div class="tab-content" id="equipment-content">
                            <h2 class="panel-title"><i class="fas fa-shield-alt"></i> 装备系统 v5.0</h2>
                            <p style="font-size: 0.85rem; color: #8B6914; margin-bottom: 8px;">穿戴装备提升属性，击败怪物有几率掉落装备，怪物越强掉落越好！装备等级最高1000级</p>
                            
                            <!-- 装备栏 - 优化后的布局 -->
                            <div class="equipment-grid" id="equipment-grid">
                                <!-- 武器槽 -->
                                <div class="equipment-slot" data-slot="weapon">
                                    <div class="equipment-icon">⚔️</div>
                                    <div class="equipment-name">武器</div>
                                    <div class="equipment-stats">未装备</div>
                                    <div class="long-press-hint">长按脱下</div>
                                </div>
                                <!-- 护甲槽 -->
                                <div class="equipment-slot" data-slot="armor">
                                    <div class="equipment-icon">🛡️</div>
                                    <div class="equipment-name">护甲</div>
                                    <div class="equipment-stats">未装备</div>
                                    <div class="long-press-hint">长按脱下</div>
                                </div>
                                <!-- 手槽 -->
                                <div class="equipment-slot" data-slot="hand">
                                    <div class="equipment-icon">✋</div>
                                    <div class="equipment-name">手</div>
                                    <div class="equipment-stats">未装备</div>
                                    <div class="long-press-hint">长按脱下</div>
                                </div>
                                <!-- 戒指槽 -->
                                <div class="equipment-slot" data-slot="ring">
                                    <div class="equipment-icon">💍</div>
                                    <div class="equipment-name">戒指</div>
                                    <div class="equipment-stats">未装备</div>
                                    <div class="long-press-hint">长按脱下</div>
                                </div>
                                <!-- 项链槽 -->
                                <div class="equipment-slot" data-slot="necklace">
                                    <div class="equipment-icon">📿</div>
                                    <div class="equipment-name">项链</div>
                                    <div class="equipment-stats">未装备</div>
                                    <div class="long-press-hint">长按脱下</div>
                                </div>
                                <!-- 鞋槽 -->
                                <div class="equipment-slot" data-slot="shoe">
                                    <div class="equipment-icon">👟</div>
                                    <div class="equipment-name">鞋</div>
                                    <div class="equipment-stats">未装备</div>
                                    <div class="long-press-hint">长按脱下</div>
                                </div>
                            </div>
                            
                            <!-- 装备详情 -->
                            <div class="equipment-details" id="equipment-details">
                                <div class="equipment-details-title">
                                    <i class="fas fa-info-circle"></i> 装备详情
                                </div>
                                <div class="equipment-details-content" id="equipment-details-content">
                                    点击装备查看详细信息
                                </div>
                            </div>
                            
                            <!-- 装备加成显示 -->
                            <div class="equipment-bonus-display">
                                <div class="equipment-bonus-title">
                                    <i class="fas fa-gem"></i> 当前装备加成
                                </div>
                                <div class="equipment-bonus-grid">
                                    <div class="equipment-bonus-item">
                                        <div class="equipment-bonus-name">攻击加成</div>
                                        <div class="equipment-bonus-value" id="total-attack-bonus">0</div>
                                    </div>
                                    <div class="equipment-bonus-item">
                                        <div class="equipment-bonus-name">防御加成</div>
                                        <div class="equipment-bonus-value" id="total-defense-bonus">0</div>
                                    </div>
                                    <div class="equipment-bonus-item">
                                        <div class="equipment-bonus-name">生命加成</div>
                                        <div class="equipment-bonus-value" id="total-hp-bonus">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 背包 -->
                            <div class="inventory-container">
                                <div class="inventory-title">
                                    <i class="fas fa-backpack"></i> 背包 ( <span id="inventory-count">0</span> / 30 )
                                </div>
                                <div class="inventory-grid" id="inventory-grid">
                                    <!-- 背包物品将在这里显示 -->
                                </div>
                                <p style="text-align: center; color: #aaa; margin-top: 8px; font-size: 0.85rem;">双击装备穿戴，长按装备槽脱下</p>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn" id="sell-equipment-btn" disabled><i class="fas fa-coins"></i> 出售选中装备</button>
                            </div>
                        </div>
                        
                        <!-- 世界BOSS内容 -->
                        <div class="tab-content" id="worldboss-content">
                            <h2 class="panel-title"><i class="fas fa-crown"></i> 世界BOSS</h2>
                            <p style="font-size: 0.85rem; color: #8B6914; margin-bottom: 8px;">挑战世界BOSS，根据累计伤害获得灵力奖励，每天只能挑战10次</p>
                            
                            <div class="world-boss-info">
                                <div class="boss-name">混沌天魔</div>
                                
                                <div class="boss-stats">
                                    <div class="boss-stat">
                                        <div class="boss-stat-value" id="boss-hp">∞</div>
                                        <div class="boss-stat-label">气血</div>
                                    </div>
                                    <div class="boss-stat">
                                        <div class="boss-stat-value" id="boss-attack">100</div>
                                        <div class="boss-stat-label">攻击</div>
                                    </div>
                                    <div class="boss-stat">
                                        <div class="boss-stat-value" id="boss-defense">10,000</div>
                                        <div class="boss-stat-label">防御</div>
                                    </div>
                                    <div class="boss-stat">
                                        <div class="boss-stat-value" id="boss-level">??</div>
                                        <div class="boss-stat-label">境界</div>
                                    </div>
                                </div>
                                
                                <div class="boss-damage-display">
                                    <div class="boss-damage-label">今日累计伤害</div>
                                    <div class="boss-damage-value" id="boss-total-damage">0</div>
                                </div>
                                
                                <div class="boss-daily-info">
                                    <div class="boss-daily-item">
                                        <div class="boss-daily-label">今日挑战次数</div>
                                        <div class="boss-daily-value" id="boss-today-challenges">0/10</div>
                                    </div>
                                    <div class="boss-daily-item">
                                        <div class="boss-daily-label">下次重置</div>
                                        <div class="boss-daily-value" id="boss-reset-time">23:59:59</div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 10px; padding: 8px; background: rgba(248, 240, 200, 0.9); border-radius: 6px; font-size: 0.85rem; color: #8B6914;">
                                    <i class="fas fa-info-circle"></i> 世界BOSS拥有无穷气血，奖励基于累计伤害计算。
                                </div>
                            </div>
                            
                            <!-- 伤害奖励阶段 -->
                            <div class="boss-reward-stages" id="boss-reward-stages">
                                <div class="reward-stage" data-stage="1" data-damage="1000000" data-reward="10000">
                                    <div class="stage-damage">100万伤害</div>
                                    <div class="stage-reward">奖励: 10,000灵力</div>
                                    <div class="stage-status">未达成</div>
                                </div>
                                <div class="reward-stage" data-stage="2" data-damage="5000000" data-reward="50000">
                                    <div class="stage-damage">500万伤害</div>
                                    <div class="stage-reward">奖励: 50,000灵力</div>
                                    <div class="stage-status">未达成</div>
                                </div>
                                <div class="reward-stage" data-stage="3" data-damage="10000000" data-reward="100000">
                                    <div class="stage-damage">1000万伤害</div>
                                    <div class="stage-reward">奖励: 100,000灵力</div>
                                    <div class="stage-status">未达成</div>
                                </div>
                                <div class="reward-stage" data-stage="4" data-damage="50000000" data-reward="500000">
                                    <div class="stage-damage">5000万伤害</div>
                                    <div class="stage-reward">奖励: 500,000灵力</div>
                                    <div class="stage-status">未达成</div>
                                </div>
                                <div class="reward-stage" data-stage="5" data-damage="100000000" data-reward="1000000">
                                    <div class="stage-damage">1亿伤害</div>
                                    <div class="stage-reward">奖励: 1,000,000灵力</div>
                                    <div class="stage-status">未达成</div>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn" id="boss-challenge-btn"><i class="fas fa-fist-raised"></i> 挑战世界BOSS</button>
                                <button class="btn" id="boss-claim-btn" disabled><i class="fas fa-coins"></i> 领取奖励</button>
                            </div>
                        </div>
                        
                        <!-- 自动回收内容 -->
                        <div class="tab-content" id="recycle-content">
                            <h2 class="panel-title"><i class="fas fa-recycle"></i> 自动回收设置</h2>
                            <p style="font-size: 0.85rem; color: #8B6914; margin-bottom: 8px;">自动回收不需要的装备，转化为灵力</p>
                            
                            <div class="auto-recycle-settings">
                                <div class="auto-recycle-title">
                                    <i class="fas fa-cog"></i> 回收设置
                                </div>
                                
                                <div class="recycle-options">
                                    <div class="recycle-option">
                                        <div class="recycle-label">
                                            <i class="fas fa-level-up-alt"></i> 等级低于
                                        </div>
                                        <select class="recycle-select" id="recycle-level">
                                            <option value="0">关闭</option>
                                            <option value="5" selected>5级</option>
                                            <option value="10">10级</option>
                                            <option value="15">15级</option>
                                            <option value="20">20级</option>
                                            <option value="25">25级</option>
                                            <option value="50">50级</option>
                                            <option value="100">100级</option>
                                            <option value="200">200级</option>
                                            <option value="500">500级</option>
                                            <option value="750">750级</option>
                                            <option value="999">999级</option>
                                            <option value="1000">1000级</option>
                                        </select>
                                    </div>
                                    
                                    <div class="recycle-option">
                                        <div class="recycle-label">
                                            <i class="fas fa-gem"></i> 品质低于
                                        </div>
                                        <select class="recycle-select" id="recycle-rarity">
                                            <option value="common" selected>普通</option>
                                            <option value="rare">稀有</option>
                                            <option value="epic">史诗</option>
                                            <option value="legendary">传说</option>
                                            <option value="none">关闭</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 12px; padding: 8px; background: rgba(248, 240, 200, 0.9); border-radius: 6px; font-size: 0.85rem; color: #8B6914;">
                                    <i class="fas fa-info-circle"></i> 自动回收将在击败怪物获得装备时自动执行，回收装备将转化为原价70%的灵力。
                                </div>
                            </div>
                            
                            <div class="auto-recycle-settings">
                                <div class="auto-recycle-title">
                                    <i class="fas fa-history"></i> 回收统计
                                </div>
                                <div class="recycle-options">
                                    <div class="recycle-option">
                                        <div class="recycle-label">
                                            <i class="fas fa-coins"></i> 累计回收灵力
                                        </div>
                                        <div style="font-size: 1.1rem; color: #B8860B; font-weight: bold; text-align: center;" id="total-recycled-spirit">0</div>
                                    </div>
                                    
                                    <div class="recycle-option">
                                        <div class="recycle-label">
                                            <i class="fas fa-trash"></i> 累计回收装备
                                        </div>
                                        <div style="font-size: 1.1rem; color: #B8860B; font-weight: bold; text-align: center;" id="total-recycled-items">0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn" id="manual-recycle-btn"><i class="fas fa-broom"></i> 立即回收背包</button>
                                <button class="btn" id="save-settings-btn"><i class="fas fa-save"></i> 保存设置</button>
                            </div>
                        </div>
                        
                        <!-- 存档管理内容 -->
                        <div class="tab-content" id="saves-content">
                            <h2 class="panel-title"><i class="fas fa-save"></i> 存档管理</h2>
                            <p style="font-size: 0.85rem; color: #8B6914; margin-bottom: 8px;">快速保存和加载游戏进度</p>
                            
                            <div class="save-manager">
                                <div class="save-manager-title">
                                    <i class="fas fa-database"></i> 当前存档信息
                                </div>
                                <div class="recycle-options">
                                    <div class="recycle-option">
                                        <div class="recycle-label">
                                            <i class="fas fa-clock"></i> 最后保存时间
                                        </div>
                                        <div style="font-size: 0.9rem; color: #B8860B; text-align: center;" id="save-time">未保存</div>
                                    </div>
                                    
                                    <div class="recycle-option">
                                        <div class="recycle-label">
                                            <i class="fas fa-gamepad"></i> 游戏版本
                                        </div>
                                        <div style="font-size: 0.9rem; color: #B8860B; text-align: center;" id="save-version">v5.0</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="btn" id="quick-save-btn"><i class="fas fa-save"></i> 快速保存</button>
                                <button class="btn" id="load-last-btn"><i class="fas fa-folder-open"></i> 加载上次存档</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 属性面板 -->
                    <div class="panel" id="attribute-panel" style="display:none">
                        <h2 class="panel-title"><i class="fas fa-user"></i> 人物属性</h2>
                        
                        <div class="character-stats">
                            <div class="stat-card">
                                <div class="stat-card-title">境界</div>
                                <div class="stat-card-value" id="character-stage">炼气初期</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">等级</div>
                                <div class="stat-card-value" id="character-level">1</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">生命值</div>
                                <div class="stat-card-value" id="character-hp">200/200</div>
                                <button class="stat-card-add" data-attr="hp">+</button>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">攻击力</div>
                                <div class="stat-card-value" id="character-attack">50</div>
                                <button class="stat-card-add" data-attr="attack">+</button>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">防御力</div>
                                <div class="stat-card-value" id="character-defense">20</div>
                                <button class="stat-card-add" data-attr="defense">+</button>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">暴击率</div>
                                <div class="stat-card-value" id="character-crit-rate">5%</div>
                                <button class="stat-card-add" data-attr="critRate">+</button>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">暴击伤害</div>
                                <div class="stat-card-value" id="character-crit-dmg">150%</div>
                                <button class="stat-card-add" data-attr="critDmg">+</button>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">闪避率</div>
                                <div class="stat-card-value" id="character-dodge">5%</div>
                                <button class="stat-card-add" data-attr="dodge">+</button>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-title">体质</div>
                                <div class="stat-card-value" id="character-constitution">10</div>
                                <button class="stat-card-add" data-attr="constitution">+</button>
                            </div>
                        </div>
                        
                        <!-- 体质加成显示 -->
                        <div class="constitution-bonus-display" id="constitution-bonus-display">
                            <i class="fas fa-heart"></i> 体质加成: 每点体质提升1%全属性
                        </div>
                        
                        <!-- 境界加成显示 -->
                        <div class="stage-bonus-display" id="stage-bonus-display">
                            <i class="fas fa-arrow-up"></i> 境界加成: 当前境界提供0%全属性加成
                        </div>
                        
                        <!-- 装备加成显示 -->
                        <div class="gold-border">
                            <div class="attribute-title">
                                <i class="fas fa-gem gold-text"></i> 装备加成
                            </div>
                            <div class="attribute-grid">
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>武器加成</span>
                                        <span class="attribute-value" id="equipment-attack-bonus">0</span>
                                    </div>
                                    <div class="attribute-cost">攻击力提升</div>
                                </div>
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>护甲加成</span>
                                        <span class="attribute-value" id="equipment-defense-bonus">0</span>
                                    </div>
                                    <div class="attribute-cost">防御力提升</div>
                                </div>
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>生命加成</span>
                                        <span class="attribute-value" id="equipment-hp-bonus">0</span>
                                    </div>
                                    <div class="attribute-cost">生命值提升</div>
                                </div>
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>套装效果</span>
                                        <span class="attribute-value" id="set-bonus">无</span>
                                    </div>
                                    <div class="attribute-cost">特殊效果</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="gold-border">
                            <div class="attribute-title">
                                <i class="fas fa-plus-circle gold-text"></i> 属性加点
                                <span style="margin-left: auto;">可用灵力: <span class="gold-text" id="available-spirit">0</span></span>
                            </div>
                            <div class="attribute-grid">
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>攻击力</span>
                                        <span class="attribute-value" id="attack-value">50</span>
                                    </div>
                                    <div class="attribute-cost">消耗: <span class="gold-text" id="attack-cost">100</span> 灵力</div>
                                    <button class="attribute-add" data-attr="attack">提升</button>
                                </div>
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>防御力</span>
                                        <span class="attribute-value" id="defense-value">20</span>
                                    </div>
                                    <div class="attribute-cost">消耗: <span class="gold-text" id="defense-cost">100</span> 灵力</div>
                                    <button class="attribute-add" data-attr="defense">提升</button>
                                </div>
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>生命值</span>
                                        <span class="attribute-value" id="hp-value">200</span>
                                    </div>
                                    <div class="attribute-cost">消耗: <span class="gold-text" id="hp-cost">100</span> 灵力</div>
                                    <button class="attribute-add" data-attr="hp">提升</button>
                                </div>
                                <div class="attribute-item">
                                    <div class="attribute-name">
                                        <span>体质</span>
                                        <span class="attribute-value" id="constitution-value">10</span>
                                    </div>
                                    <div class="attribute-cost">消耗: <span class="gold-text" id="constitution-cost">200</span> 灵力</div>
                                    <button class="attribute-add" data-attr="constitution">提升</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 已选天赋显示 -->
                        <div class="selected-buffs-container">
                            <div class="selected-buffs-title">
                                <i class="fas fa-star"></i> 已选天赋
                            </div>
                            <div class="selected-buffs-grid" id="selected-buffs-grid">
                                <!-- 已选天赋将在这里显示 -->
                            </div>
                        </div>
                        
                        <div class="special-attributes">
                            <div class="special-attribute">
                                <div class="special-name">吸血率</div>
                                <div class="special-value" id="character-lifeSteal">0%</div>
                            </div>
                            <div class="special-attribute">
                                <div class="special-name">连击率</div>
                                <div class="special-value" id="character-combo">0%</div>
                            </div>
                            <div class="special-attribute">
                                <div class="special-name">修炼速度</div>
                                <div class="special-value" id="character-cultivation-speed">100%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="side-content">
                    <!-- 修仙境界面板 -->
                    <div class="panel">
                        <h2 class="panel-title"><i class="fas fa-fire"></i> 修仙境界
                            <span class="current-stage-display" id="current-stage-display">炼气初期</span>
                        </h2>
                        <div class="spirit-power">
                            <span class="spirit-icon"></span> 
                            <div>
                                <div>灵力: <span id="spirit-power">0</span></div>
                                <div class="spirit-per-minute">每5秒收益: <span id="spirit-per-minute">0</span></div>
                            </div>
                        </div>
                        
                        <!-- 等级进度 -->
                        <div class="progress-container">
                            <div class="progress-label">
                                <span>等级进度</span>
                                <span><span id="stage-progress-value">0</span>%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                                <div class="progress-text" id="progress-text">等级 1 · 0%</div>
                            </div>
                        </div>
                        
                        <!-- 境界修炼进度 -->
                        <div class="cultivation-progress-container">
                            <div class="progress-label">
                                <span>境界修炼进度</span>
                                <span><span id="cultivation-progress-value">0</span>%</span>
                            </div>
                            <div class="cultivation-progress-bar">
                                <div class="cultivation-progress-fill" id="cultivation-progress-fill" style="width: 0%"></div>
                                <div class="cultivation-progress-text" id="cultivation-progress-text">炼气初期 · 0%</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn cultivate-btn" id="cultivate-btn"><i class="fas fa-meditation"></i> 闭关修炼</button>
                            <button class="btn" id="reset-game-btn-2" style="display:none"><i class="fas fa-redo"></i> 重置游戏</button>
                        </div>
                    </div>
                    
                    <!-- 战斗区域 -->
                    <div class="panel monster-battle" id="monster-battle">
                        <h2 class="panel-title"><i class="fas fa-dragon"></i> 妖兽挑战</h2>
                        
                        <div class="monster-scroll" id="monster-selection">
                            <!-- Monster options will be generated here -->
                        </div>
                        
                        <div class="monster-name" id="monster-name">赤焰妖虎</div>
                        <div class="monster-stats">
                            <div class="stat">
                                <div class="stat-value" id="monster-hp">400</div>
                                <div class="stat-label">气血</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="monster-attack">40</div>
                                <div class="stat-label">攻击</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="monster-defense">10</div>
                                <div class="stat-label">防御</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value" id="monster-cultivation">炼气中期</div>
                                <div class="stat-label">修为</div>
                            </div>
                        </div>
                        
                        <div class="battle-status">
                            <div class="status-item">
                                <div class="status-label">你的生命</div>
                                <div class="status-value" id="player-hp-display">200/200</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">怪物生命</div>
                                <div class="status-value" id="monster-hp-display">400/400</div>
                            </div>
                        </div>
                        
                        <div class="battle-info" id="battle-info">
                            战斗尚未开始...
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn battle-btn" data-action="attack" id="attack-btn"><i class="fas fa-fist-raised"></i> 攻击</button>
                            <button class="btn auto-battle-btn" id="auto-battle-btn"><i class="fas fa-robot"></i> 自动战斗</button>
                        </div>
                        
                        <div class="resurrect-overlay" id="resurrect-overlay" style="display:none">
                            <div class="resurrect-title">角色已阵亡</div>
                            <div class="resurrect-timer">复活倒计时: <span id="resurrect-timer">5</span>秒</div>
                        </div>
                    </div>
                    
                    <!-- 页脚信息 -->
                    <div class="footer">
                        <p>修仙模拟器 | 当前版本: 5.0</p>
                        <div class="cultivation-info">
                            <div class="info-item">
                                <i class="fas fa-bolt"></i> 每5秒灵力: <span class="info-value" id="current-reward">0</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-shield-alt"></i> 当前境界: <span class="info-value" id="current-stage">炼气初期</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-dragon"></i> 妖兽击败: <span class="info-value" id="monster-defeated">0</span>
                            </div>
                        </div>
                        <div class="cultivation-info" style="margin-top:8px">
                            <div class="info-item">
                                <i class="fas fa-clock"></i> 游戏时间: <span class="info-value" id="game-time">00:00:00</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-save"></i> 自动保存: <span class="info-value" id="last-save">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 移动端底部导航 -->
    <div class="mobile-nav">
        <div class="nav-item active" data-target="talent-panel">
            <i class="fas fa-magic"></i>
            <span>天赋</span>
        </div>
        <div class="nav-item" data-target="attribute-panel">
            <i class="fas fa-user"></i>
            <span>属性</span>
        </div>
        <div class="nav-item" data-target="cultivate-btn">
            <i class="fas fa-meditation"></i>
            <span>修炼</span>
        </div>
        <div class="nav-item" data-target="monster-battle">
            <i class="fas fa-dragon"></i>
            <span>妖兽</span>
        </div>
        <div class="nav-item" data-target="worldboss-content">
            <i class="fas fa-crown"></i>
            <span>BOSS</span>
        </div>
    </div>

    <script>
        // ============================
        // 游戏数据与状态管理
        // ============================
        const GameState = {
            VERSION: '5.0',
            
            // 基础资源
            spiritPower: 0,
            refreshCount: 10,
            cultivationStage: '炼气初期',
            stageProgress: 0,
            cultivationProgress: 0,
            selectedBuffs: [],
            buffs: [],
            
            // 角色属性
            character: {
                baseHp: 200,
                baseAttack: 50,
                baseDefense: 20,
                baseCritRate: 5,
                baseCritDmg: 150,
                baseDodge: 5,
                baseLifeSteal: 0,
                baseCombo: 0,
                baseConstitution: 10,
                hp: 200,
                maxHp: 200,
                attack: 50,
                defense: 20,
                critRate: 5,
                critDmg: 150,
                dodge: 5,
                lifeSteal: 0,
                combo: 0,
                constitution: 10,
                penetration: 0,
                isAlive: true,
                experience: 0,
                level: 1
            },
            
            // 怪物数据
            monster: {
                name: '赤焰妖虎',
                hp: 400,
                maxHp: 400,
                attack: 40,
                defense: 10,
                cultivation: '炼气中期',
                rewardMin: 30,
                rewardMax: 50,
                level: 1
            },
            
            // 世界BOSS数据
            worldBoss: {
                name: '混沌天魔',
                hp: Infinity, // 无穷血量
                maxHp: Infinity,
                defense: 10000,
                attack: 100,
                dailyChallenges: 10,
                lastChallengeDate: null,
                todayChallenges: 0,
                totalDamage: 0,
                rewardStages: [
                    { damage: 1000000, reward: 10000, claimed: false },
                    { damage: 5000000, reward: 50000, claimed: false },
                    { damage: 10000000, reward: 100000, claimed: false },
                    { damage: 50000000, reward: 500000, claimed: false },
                    { damage: 100000000, reward: 1000000, claimed: false }
                ]
            },
            
            // 修炼消耗数列 - 优化后的数值
            cultivationCosts: {
                '炼气初期': 100/100,
                '炼气中期': 200/100,
                '炼气后期': 400/100,
                '筑基初期': 800/100,
                '筑基中期': 1600/100,
                '筑基后期': 3200/100,
                '金丹初期': 6400/100,
                '金丹中期': 12800/100,
                '金丹后期': 25600/100,
                '元婴初期': 51200/100,
                '元婴中期': 102400/100,
                '元婴后期': 204800/100,
                '化神初期': 409600/100,
                '化神中期': 819200/100,
                '化神后期': 1638400/100,
                '炼虚初期': 3276800/100,
                '炼虚中期': 6553600/100,
                '炼虚后期': 13107200/100,
                '合体初期': 26214400/100,
                '合体中期': 52428800/100,
                '合体后期': 104857600/100,
                '大乘初期': 209715200/100,
                '大乘中期': 419430400/100,
                '大乘后期': 838860800/100,
                '渡劫初期': 1677721600/100,
                '渡劫中期': 3355443200/100,
                '渡劫后期': 6710886400/100,
                '飞升期': 13421772800,
                "真仙":13421772800*2,
                '金仙':13421772800*4,
                '太乙金仙':13421772800*8,
                '大罗金仙':13421772800*16,
                '混元大罗金仙':13421772800*32,
                '仙帝':13421772800*64,
                '神君':13421772800*128,
                '神王':13421772800*256,
                '神皇':13421772800*512,
                '神尊':13421772800*1024,
                '至高神': 13421772800 * 2048
            },
            
            // 境界加成 - 优化后的数值
            stageBonuses: {
                '炼气初期': 0,
                '炼气中期': 5,
                '炼气后期': 10,
                '筑基初期': 20,
                '筑基中期': 30,
                '筑基后期': 40,
                '金丹初期': 60,
                '金丹中期': 80,
                '金丹后期': 100,
                '元婴初期': 150,
                '元婴中期': 200,
                '元婴后期': 250,
                '化神初期': 350,
                '化神中期': 450,
                '化神后期': 550,
                '炼虚初期': 700,
                '炼虚中期': 850,
                '炼虚后期': 1000,
                '合体初期': 1200,
                '合体中期': 1400,
                '合体后期': 1600,
                '大乘初期': 20000,
                '大乘中期': 24000,
                '大乘后期': 28000,
                '渡劫初期': 35000,
                '渡劫中期': 42000,
                '渡劫后期': 49000,
                '飞升期': 100000,
                "真仙": 150000,
                "金仙": 200000,
                "太乙金仙": 250000,
                "大罗金仙": 300000,
                "混元大罗金仙": 350000,
                "仙帝": 400000,
                "神君": 450000,
                "神王": 500000,
                "神皇": 550000,
                "神尊": 650000,
                "至高神": 750000
            },
            
            // 属性加点消耗 - 优化后的数值
            attributeCosts: {
                attack: { base: 100, increment: 100, level: 0 },
                defense: { base: 100, increment: 100, level: 0 },
                hp: { base: 100, increment: 100, level: 0 },
                critRate: { base: 200, increment: 1000, level: 0 },
                critDmg: { base: 200, increment: 1000, level: 0 },
                dodge: { base: 200, increment: 1000, level: 0 },
                lifeSteal: { base: 300, increment: 1000, level: 0 },
                combo: { base: 300, increment: 1000, level: 0 },
                constitution: { base: 200, increment: 1000, level: 0 }
            },
            
            // 游戏状态
            cultivationInterval: null,
            inBattle: false,
            monsterDefeated: 0,
            stageReward: 10,
            autoBattleInterval: null,
            autoBattleActive: false,
            gameTime: 0,
            lastSaveTime: null,
            
            // 装备系统数据
            equipment: {
                weapon: null,
                armor: null,
                hand: null,
                ring: null,
                necklace: null,
                shoe: null
            },
            inventory: [],
            selectedInventoryItem: null,
            
            // 自动回收设置
            autoRecycle: {
                enabled: true,
                levelThreshold: 5,
                rarityThreshold: 'common',
                totalRecycledSpirit: 0,
                totalRecycledItems: 0
            },
            
            // 游戏设置
            settings: {
                autosaveEnabled: true,
                animationEnabled: true,
                saveInterval: 30000
            }
        };
        
        // ============================
        // 游戏常量
        // ============================
        const CULTIVATION_STAGES = [
            '炼气初期', '炼气中期', '炼气后期',
            '筑基初期', '筑基中期', '筑基后期',
            '金丹初期', '金丹中期', '金丹后期',
            '元婴初期', '元婴中期', '元婴后期',
            '化神初期', '化神中期', '化神后期',
            '炼虚初期', '炼虚中期', '炼虚后期',
            '合体初期', '合体中期', '合体后期',
            '大乘初期', '大乘中期', '大乘后期',
            '渡劫初期', '渡劫中期', '渡劫后期',
            '飞升期',"真仙",'金仙','太乙金仙',
            '大罗金仙','混元大罗金仙','仙帝', 
            '神君','神王','神皇',
            '神尊','至高神',
        ];
        
        // 怪物数据
        const MONSTERS_BY_LEVEL = {
            1: { name: '赤焰妖虎', hp: 400, maxHp: 400, attack: 40, defense: 10, cultivation: '炼气中期', rewardMin: 30, rewardMax: 50 },
            2: { name: '寒冰巨蟒', hp: 50000, maxHp: 50000, attack: 5000, defense: 2000, cultivation: '筑基初期', rewardMin: 60, rewardMax: 100 },
            3: { name: '雷霆金鹏', hp: 120000, maxHp: 120000, attack: 12000, defense: 4500, cultivation: '金丹初期', rewardMin: 120, rewardMax: 180 },
            4: { name: '熔岩巨人', hp: 350000, maxHp: 350000, attack: 35000, defense: 10000, cultivation: '元婴初期', rewardMin: 240, rewardMax: 360 },
            5: { name: '九幽蛟龙', hp: 2000000, maxHp: 2000000, attack: 150000, defense: 40000, cultivation: '化神初期', rewardMin: 480, rewardMax: 720 },
            6: { name: '玄冰凤凰', hp: 5000000, maxHp: 5000000, attack: 5400000, defense: 100000, cultivation: '炼虚初期', rewardMin: 960, rewardMax: 1440 },
            7: { name: '混沌石灵', hp: 12000000, maxHp: 12000000, attack: 1300000, defense: 150000, cultivation: '合体初期', rewardMin: 1920, rewardMax: 2880 },
            8: { name: '九天神龙', hp: 200000000, maxHp: 200000000, attack: 3000000, defense: 2000000, cultivation: '大乘初期', rewardMin: 3840, rewardMax: 5760 },
            9: { name: '虚空天魔', hp: 500000000, maxHp: 500000000, attack: 5000000, defense: 5000000, cultivation: '渡劫初期', rewardMin: 7680, rewardMax: 11520 },
            10: { name: '真仙战傀', hp: 20000000000, maxHp: 20000000000, attack: 100000000, defense: 80000000, cultivation: '真仙期', rewardMin: 150000, rewardMax: 200000 },
            11: { name: '金仙法身', hp: 50000000000, maxHp: 50000000000, attack: 250000000, defense: 150000000, cultivation: '金仙期', rewardMin: 300000, rewardMax: 400000 },
            12: { name: '太乙金仙残魂', hp: 100000000000, maxHp: 100000000000, attack: 500000000, defense: 300000000, cultivation: '太乙金仙期', rewardMin: 600000, rewardMax: 800000 },
            13: { name: '大罗金仙投影', hp: 5000000000000, maxHp: 5000000000000, attack: 2000000000, defense: 1000000000, cultivation: '真仙期', rewardMin: 1200000, rewardMax: 1600000 },
            14: { name: '混元大罗金仙意念', hp: 20000000000000, maxHp: 20000000000000, attack: 8000000000, defense: 4000000000, cultivation: '混元大罗金仙期', rewardMin: 2400000, rewardMax: 3200000 },
            15: { name: '仙帝虚影', hp: 100000000000000, maxHp: 100000000000000, attack: 30000000000, defense: 20000000000, cultivation: '仙帝期', rewardMin: 5000000, rewardMax: 7000000 },
            16: { name: '神君化身', hp: 500000000000000, maxHp: 500000000000000, attack: 100000000000, defense: 80000000000, cultivation: '神君期', rewardMin: 10000000, rewardMax: 15000000 },
            17: { name: '神王分身', hp: 2000000000000000, maxHp: 2000000000000000, attack: 300000000000, defense: 200000000000, cultivation: '神王期', rewardMin: 200000000, rewardMax: 300000000 },
            18: { name: '神皇意志', hp: 100000000000000000, maxHp: 100000000000000000, attack: 10000000000000, defense: 8000000000000, cultivation: '神皇期', rewardMin: 500000000, rewardMax: 800000000 },
            19: { name: '神尊法相', hp: 50000000000000000000, maxHp: 50000000000000000000, attack: 3000000000000, defense: 2000000000000, cultivation: '神尊期', rewardMin: 10000000000, rewardMax: 15000000000 },
            20: { name: '至高神虚影', hp: 1000000000000000000000, maxHp: 1000000000000000000000, attack: 500000000000000, defense: 400000000000000, cultivation: '至高神期', rewardMin: 200000000000, rewardMax: 300000000000 }
        };
        
        // 装备类型定义
        const EQUIPMENT_TYPES = [
            { id: 'weapon', name: '武器', icon: '⚔️' },
            { id: 'armor', name: '护甲', icon: '🛡️' },
            { id: 'hand', name: '手', icon: '✋' },
            { id: 'ring', name: '戒指', icon: '💍' },
            { id: 'necklace', name: '项链', icon: '📿' },
            { id: 'shoe', name: '鞋', icon: '👟' }
        ];
        
        // 装备稀有度
        const EQUIPMENT_RARITIES = [
            { id: 'common', name: '普通', color: '#999', weight: 40, multiplier: 1.0 },
            { id: 'rare', name: '稀有', color: '#4682b4', weight: 30, multiplier: 1.5 },
            { id: 'epic', name: '史诗', color: '#9370db', weight: 20, multiplier: 2.0 },
            { id: 'legendary', name: '传说', color: '#daa520', weight: 10, multiplier: 3.0 }
        ];
        
        // 装备属性池 - 优化后的词条
        const EQUIPMENT_STATS = {
            weapon: {
                primary: 'attack',
                possibleStats: ['attack', 'critRate', 'critDmg', 'lifeSteal', 'attackPercent', 'damageIncrease']
            },
            armor: {
                primary: 'defense',
                possibleStats: ['defense', 'hp', 'dodge', 'defensePercent']
            },
            hand: {
                primary: 'critRate',
                possibleStats: ['critRate', 'attack', 'defense', 'combo', 'attackPercent']
            },
            ring: {
                primary: 'critDmg',
                possibleStats: ['critDmg', 'critRate', 'lifeSteal', 'attack', 'damageIncrease']
            },
            necklace: {
                primary: 'hp',
                possibleStats: ['hp', 'lifeSteal', 'dodge', 'defense', 'hpPercent']
            },
            shoe: {
                primary: 'dodge',
                possibleStats: ['dodge', 'hp', 'defense', 'combo', 'dodgePercent']
            }
        };
        
        // 装备名称前缀和后缀
        const EQUIPMENT_PREFIXES = {
            common: ['普通的', '平凡的', '粗糙的', '简易的'],
            rare: ['精致的', '优质的', '坚固的', '锋利的'],
            epic: ['强大的', '稀有的', '珍贵的', '神秘的'],
            legendary: ['传说的', '神话的', '不朽的', '神圣的']
        };
        
        const EQUIPMENT_SUFFIXES = {
            weapon: ['剑', '刀', '斧', '杖', '弓'],
            armor: ['甲', '袍', '衣', '铠', '服'],
            hand: ['手套', '护手', '拳套', '手甲'],
            ring: ['戒指', '指环', '戒'],
            necklace: ['项链', '吊坠', '护符'],
            shoe: ['靴', '鞋', '履', '足具']
        };
        
        // 天赋池
        const BUFF_POOL = [
            { id: 1, name: '体魄强健', rarity: 'common', desc: '气血上限提升10%', effect: "hp", value: 0.1 },
            { id: 2, name: '经脉通畅', rarity: 'common', desc: '灵力恢复速度提升15%', effect: "spiritGain", value: 0.15 },
            { id: 3, name: '悟性提升', rarity: 'common', desc: '修炼速度提升10%', effect: "cultivationSpeed", value: 0.1 },
            { id: 4, name: '基础剑诀', rarity: 'common', desc: '攻击力提升15%', effect: "attack", value: 0.15 },
            { id: 5, name: '铁骨铮铮', rarity: 'common', desc: '防御力提升10%', effect: "defense", value: 0.1 },
            { id: 10, name: '五行灵根', rarity: 'rare', desc: '全属性抗性提升20%', effect: "defense", value: 0.2 },
            { id: 11, name: '御器精通', rarity: 'rare', desc: '攻击力提升30%', effect: "attack", value: 0.3 },
            { id: 12, name: '神识敏锐', rarity: 'rare', desc: '闪避率提升10%', effect: "dodge", value: 0.1 },
            { id: 13, name: '剑意初成', rarity: 'rare', desc: '攻击力提升35%', effect: "attack", value: 0.35 },
            { id: 17, name: '九转金丹', rarity: 'epic', desc: '突破成功率提升50%，灵力上限增加30%', effect: "cultivationSpeed", value: 0.5 },
            { id: 18, name: '剑意凛然', rarity: 'epic', desc: '攻击力提升70%，暴击率增加15%', effect: "crit", value: 0.15 },
            { id: 19, name: '凤凰血脉', rarity: 'epic', desc: '死亡后30%概率复活，全属性提升25%', effect: "revive", value: 0.25 },
            { id: 20, name: '时间法则', rarity: 'epic', desc: '挂机收益提升100%', effect: "spiritGain", value: 1.0 },
            { id: 24, name: '混沌道体', rarity: 'legendary', desc: '全属性提升50%，修炼无瓶颈', effect: "all", value: 0.5 },
            { id: 25, name: '天道眷顾', rarity: 'legendary', desc: '奇遇概率提升150%，获得稀有物品概率翻倍', effect: "luck", value: 1.5 },
            { id: 26, name: '不朽金身', rarity: 'legendary', desc: '免疫一切控制，受到伤害降低50%', effect: "defense", value: 0.5 },
            { id: 27, name: '万法归一', rarity: 'legendary', desc: '所有伤害提升100%', effect: "attack", value: 1.0 }
        ];
        
        // 稀有度权重
        const RARITY_WEIGHTS = {
            'common': 40,
            'rare': 30,
            'epic': 20,
            'legendary': 10
        };
        
        // 数字单位定义
        const NUMBER_UNITS = [
            { threshold: 1e4, suffix: '万', divisor: 1e4 },
            { threshold: 1e8, suffix: '亿', divisor: 1e8 },
            { threshold: 1e12, suffix: '兆', divisor: 1e12 },
            { threshold: 1e16, suffix: '京', divisor: 1e16 },
            { threshold: 1e20, suffix: '玄1', divisor: 1e20 },
            { threshold: 1e24, suffix: '玄2', divisor: 1e24 },
            { threshold: 1e28, suffix: '玄3', divisor: 1e28 },
            { threshold: 1e32, suffix: '玄4', divisor: 1e32 },
            { threshold: 1e36, suffix: '玄5', divisor: 1e36 },
            { threshold: 1e40, suffix: '玄6', divisor: 1e40 },
            { threshold: 1e44, suffix: '玄7', divisor: 1e44 },
            { threshold: 1e48, suffix: '玄8', divisor: 1e48 },
            { threshold: 1e52, suffix: '玄9', divisor: 1e52 },
            { threshold: 1e56, suffix: '玄10', divisor: 1e56 }
        ];
        
        // ============================
        // 核心游戏功能
        // ============================
        
        // 初始化游戏
        function initGame() {
            showLoading(true);
            
            // 加载保存的游戏数据
            loadGameData();
            
            // 初始化天赋
            refreshBuffs();
            
            // 初始化怪物选项
            initMonsterOptions();
            
            // 初始化装备系统
            initEquipment();
            
            // 初始化自动回收设置
            initAutoRecycle();
            
            // 初始化世界BOSS
            initWorldBoss();
            
            // 开始游戏计时器
            startGameTimer();
            
            // 开始自动保存
            if (GameState.settings.autosaveEnabled) {
                startAutoSave();
            }
            
            // 更新UI
            updateUI();
            
            // 隐藏加载界面
            setTimeout(() => {
                showLoading(false);
                showNotification('欢迎归来', '修仙之路继续，祝道友早日得道成仙！');
            }, 1000);
        }
        
        // 显示/隐藏加载界面
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        // 显示通知
        function showNotification(title, content) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationContent = document.getElementById('notification-content');
            
            notificationTitle.textContent = title;
            notificationContent.textContent = content;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 格式化数字为中文单位
        function formatNumberWithUnit(num) {
            if (num === Infinity) return '∞';
            if (num < 10000) return num.toString();
            
            for (let i = NUMBER_UNITS.length - 1; i >= 0; i--) {
                if (num >= NUMBER_UNITS[i].threshold) {
                    return (num / NUMBER_UNITS[i].divisor).toFixed(1) + NUMBER_UNITS[i].suffix;
                }
            }
            
            return num.toString();
        }
        
        // 计算属性（包含装备、天赋和境界加成）
        function calculateAttributes() {
            // 重置为基础属性
            GameState.character.maxHp = GameState.character.baseHp;
            GameState.character.attack = GameState.character.baseAttack;
            GameState.character.defense = GameState.character.baseDefense;
            GameState.character.critRate = GameState.character.baseCritRate;
            GameState.character.critDmg = GameState.character.baseCritDmg;
            GameState.character.dodge = GameState.character.baseDodge;
            GameState.character.lifeSteal = GameState.character.baseLifeSteal;
            GameState.character.combo = GameState.character.baseCombo;
            GameState.character.constitution = GameState.character.baseConstitution;
            GameState.character.penetration = 0;
            
            // 应用体质加成
            let constitutionBonus = 0;
            if (GameState.character.constitution >= 1000) {
                constitutionBonus = 5000; // 50000%额外加成
            } else if (GameState.character.constitution >= 500) {
                constitutionBonus = 1000; // 1000%额外加成
            } else if (GameState.character.constitution >= 300) {
                constitutionBonus = 500; // 500%额外加成
            } else if (GameState.character.constitution >= 100) {
                constitutionBonus = 100; // 100%额外加成
            }
            
            const totalConstitutionMultiplier = 1 + (GameState.character.constitution * 0.01) + (constitutionBonus / 100);
            
            GameState.character.maxHp *= totalConstitutionMultiplier;
            GameState.character.attack *= totalConstitutionMultiplier;
            GameState.character.defense *= totalConstitutionMultiplier;
            GameState.character.critRate *= totalConstitutionMultiplier;
            GameState.character.critDmg *= totalConstitutionMultiplier;
            GameState.character.dodge *= totalConstitutionMultiplier;
            GameState.character.lifeSteal *= totalConstitutionMultiplier;
            GameState.character.combo *= totalConstitutionMultiplier;
            
            // 更新体质加成显示
            const constitutionDisplay = document.getElementById('constitution-bonus-display');
            constitutionDisplay.className = 'constitution-bonus-display';
            if (constitutionBonus > 0) {
                constitutionDisplay.classList.add('constitution-bonus-active');
                constitutionDisplay.innerHTML = `<i class="fas fa-heart"></i> 体质加成: 每点体质提升1%全属性 + 额外${constitutionBonus}%加成`;
            } else {
                constitutionDisplay.innerHTML = `<i class="fas fa-heart"></i> 体质加成: 每点体质提升1%全属性`;
            }
            
            // 应用境界加成
            const stageBonus = GameState.stageBonuses[GameState.cultivationStage] || 0;
            const stageMultiplier = 1 + (stageBonus / 100);
            
            GameState.character.maxHp *= stageMultiplier;
            GameState.character.attack *= stageMultiplier;
            GameState.character.defense *= stageMultiplier;
            GameState.character.critRate *= stageMultiplier;
            GameState.character.critDmg *= stageMultiplier;
            GameState.character.dodge *= stageMultiplier;
            GameState.character.lifeSteal *= stageMultiplier;
            GameState.character.combo *= stageMultiplier;
            
            // 更新境界加成显示
            const stageDisplay = document.getElementById('stage-bonus-display');
            stageDisplay.className = 'stage-bonus-display';
            if (stageBonus > 0) {
                stageDisplay.classList.add('stage-bonus-active');
                stageDisplay.innerHTML = `<i class="fas fa-arrow-up"></i> 境界加成: 当前境界提供${stageBonus}%全属性加成`;
            } else {
                stageDisplay.innerHTML = `<i class="fas fa-arrow-up"></i> 境界加成: 当前境界提供0%全属性加成`;
            }
            
            // 应用天赋加成
            GameState.selectedBuffs.forEach(buff => {
                applyBuffEffect(buff);
            });
            
            // 应用装备加成
            applyEquipmentEffects();
            
            // 暴击率转换：超过100%的部分转换为5倍爆伤
            if (GameState.character.critRate > 100) {
                const excessCrit = GameState.character.critRate - 100;
                GameState.character.critRate = 100;
                GameState.character.critDmg += excessCrit * 5;
            }
            
            // 闪避转换：最高80%，超过部分转换为穿透
            if (GameState.character.dodge > 80) {
                const excessDodge = GameState.character.dodge - 80;
                GameState.character.dodge = 80;
                GameState.character.penetration += excessDodge;
            }
            
            // 确保属性不超过上限
            GameState.character.dodge = Math.min(GameState.character.dodge, 80);
            GameState.character.critRate = Math.min(GameState.character.critRate, 100);
            GameState.character.lifeSteal = Math.min(GameState.character.lifeSteal, 80);
            GameState.character.combo = Math.min(GameState.character.combo, 80);
            
            // 更新当前生命值
            GameState.character.hp = Math.min(GameState.character.hp, GameState.character.maxHp);
        }
        
        // 应用天赋效果
        function applyBuffEffect(buff) {
            switch(buff.effect) {
                case "hp":
                    GameState.character.maxHp *= (1 + buff.value);
                    break;
                case "attack":
                    GameState.character.attack *= (1 + buff.value);
                    break;
                case "defense":
                    GameState.character.defense *= (1 + buff.value);
                    break;
                case "dodge":
                    GameState.character.dodge += buff.value * 100;
                    break;
                case "crit":
                    GameState.character.critRate += buff.value * 100;
                    break;
                case "lifeSteal":
                    GameState.character.lifeSteal += buff.value * 100;
                    break;
                case "combo":
                    GameState.character.combo += buff.value * 100;
                    break;
                case "all":
                    GameState.character.maxHp *= (1 + buff.value);
                    GameState.character.attack *= (1 + buff.value);
                    GameState.character.defense *= (1 + buff.value);
                    GameState.character.critRate += buff.value * 100;
                    GameState.character.critDmg += buff.value * 100;
                    GameState.character.dodge += buff.value * 100;
                    GameState.character.lifeSteal += buff.value * 100;
                    GameState.character.combo += buff.value * 100;
                    break;
                case "spiritGain":
                case "cultivationSpeed":
                case "revive":
                case "luck":
                    // 这些效果在相关计算时处理
                    break;
            }
        }
        
        // ============================
        // 装备系统
        // ============================
        
        // 初始化装备系统
        function initEquipment() {
            // 更新装备栏显示
            updateEquipmentDisplay();
            
            // 更新背包显示
            updateInventoryDisplay();
            
            // 添加初始装备到背包
            const initialWeapon = generateEquipment('weapon', 1, 'common');
            const initialArmor = generateEquipment('armor', 1, 'common');
            
            if (initialWeapon) addToInventory(initialWeapon);
            if (initialArmor) addToInventory(initialArmor);
            
            // 更新UI
            updateInventoryDisplay();
        }
        
        // 生成随机装备
        function generateEquipment(type, monsterLevel, forcedRarity = null) {
            // 确定装备等级：最高1000级
            const level = calculateEquipmentLevel(monsterLevel);
            
            // 确定稀有度
            const rarity = forcedRarity || calculateEquipmentRarity(monsterLevel);
            
            // 获取稀有度数据
            const rarityData = EQUIPMENT_RARITIES.find(r => r.id === rarity);
            if (!rarityData) return null;
            
            // 获取装备类型数据
            const typeData = EQUIPMENT_TYPES.find(t => t.id === type);
            if (!typeData) return null;
            
            // 生成装备名称
            const prefix = EQUIPMENT_PREFIXES[rarity][Math.floor(Math.random() * EQUIPMENT_PREFIXES[rarity].length)];
            const suffix = EQUIPMENT_SUFFIXES[type][Math.floor(Math.random() * EQUIPMENT_SUFFIXES[type].length)];
            const name = `${prefix}${suffix}`;
            
            // 生成基础属性（基于等级和稀有度）
            const baseStats = generateBaseStats(type, level, rarityData.multiplier);
            
            // 随机添加附加属性（稀有度越高，附加属性越多）
            const additionalStats = generateAdditionalStats(type, rarity);
            
            // 合并属性
            const stats = { ...baseStats, ...additionalStats };
            
            // 计算价格
            const price = calculateEquipmentPrice(stats, level, rarityData.multiplier);
            
            // 生成描述
            const desc = generateEquipmentDescription(name, type, level, rarity, stats);
            
            // 创建装备对象
            const equipment = {
                id: Date.now() + Math.floor(Math.random() * 1000),
                name: name,
                type: type,
                rarity: rarity,
                level: level,
                ...stats,
                price: price,
                desc: desc,
                icon: typeData.icon
            };
            
            return equipment;
        }
        
        // 计算装备等级 - 最高1000级
        function calculateEquipmentLevel(monsterLevel) {
            const MAX_LEVEL = 1000;
            
            // 基础概率分布
            const rand = Math.random();
            
            // 确保低等级怪物也有机会掉落1000级装备
            if (rand < 0.005) { // 0.5%概率
                return MAX_LEVEL;
            }
            
            // 重新计算概率（排除0.5%的传奇概率）
            const adjustedRand = (rand - 0.005) / 0.995;
            
            if (adjustedRand < 0.6) {
                // 60%概率：正常范围 (怪物等级±3)
                const min = Math.max(1, monsterLevel - 3);
                const max = Math.min(MAX_LEVEL, monsterLevel + 3);
                return min + Math.floor(Math.random() * (max - min + 1));
            } else if (adjustedRand < 0.9) {
                // 30%概率：较好范围 (怪物等级+3到怪物等级*2+10)
                const min = Math.min(MAX_LEVEL, monsterLevel + 3);
                const max = Math.min(MAX_LEVEL, monsterLevel * 2 + 10);
                return min + Math.floor(Math.random() * (max - min + 1));
            } else {
                // 9.5%概率：传奇范围
                const min = Math.min(MAX_LEVEL, monsterLevel * 2 + 10);
                const max = MAX_LEVEL;
                
                // 使用指数分布，更倾向于高等级
                const exponentialFactor = Math.pow(Math.random(), 0.3);
                const levelRange = max - min + 1;
                const levelOffset = Math.floor(levelRange * exponentialFactor);
                
                return Math.min(MAX_LEVEL, min + levelOffset);
            }
        }
        
        // 计算装备稀有度
        function calculateEquipmentRarity(monsterLevel) {
            // 基础概率
            let probabilities = {
                common: 0.5,
                rare: 0.3,
                epic: 0.15,
                legendary: 0.05
            };
            
            // 根据怪物等级调整概率
            const levelFactor = Math.min(monsterLevel / 10, 1);
            
            probabilities.common = Math.max(0.1, 0.5 - levelFactor * 0.4);
            probabilities.rare = Math.min(0.4, 0.3 + levelFactor * 0.2);
            probabilities.epic = Math.min(0.3, 0.15 + levelFactor * 0.2);
            probabilities.legendary = Math.min(0.2, 0.05 + levelFactor * 0.15);
            
            // 低等级怪物也有极小概率掉落传奇装备
            if (monsterLevel <= 3) {
                probabilities.legendary = 0.01;
            }
            
            // 归一化
            const total = probabilities.common + probabilities.rare + probabilities.epic + probabilities.legendary;
            probabilities.common /= total;
            probabilities.rare /= total;
            probabilities.epic /= total;
            probabilities.legendary /= total;
            
            // 随机选择稀有度
            const rand = Math.random();
            let cumulative = 0;
            
            for (const rarity in probabilities) {
                cumulative += probabilities[rarity];
                if (rand <= cumulative) {
                    return rarity;
                }
            }
            
            return 'common';
        }
        
        // 生成基础属性
        function generateBaseStats(type, level, rarityMultiplier) {
            const stats = {};
            const typeData = EQUIPMENT_STATS[type];
            
            if (!typeData) return stats;
            
            // 主属性
            const primaryValue = Math.floor(level * 5 * rarityMultiplier);
            stats[typeData.primary] = primaryValue;
            
            // 根据装备类型添加额外基础属性
            switch(type) {
                case 'weapon':
                    stats.attack = primaryValue;
                    break;
                case 'armor':
                    stats.defense = Math.floor(level * 3 * rarityMultiplier);
                    stats.hp = Math.floor(level * 100 * rarityMultiplier);
                    break;
                case 'hand':
                    stats.critRate = Math.floor(level * 3 * rarityMultiplier);
                    break;
                case 'ring':
                    stats.critDmg = Math.floor(level * 10 * rarityMultiplier);
                    break;
                case 'necklace':
                    stats.hp = Math.floor(level * 50 * rarityMultiplier);
                    break;
                case 'shoe':
                    stats.dodge = Math.floor(level * 1 * rarityMultiplier);
                    stats.hp = Math.floor(level * 50 * rarityMultiplier);
                    break;
            }
            
            return stats;
        }
        
        // 生成附加属性
        function generateAdditionalStats(type, rarity) {
            const stats = {};
            const typeData = EQUIPMENT_STATS[type];
            
            if (!typeData) return stats;
            
            // 根据稀有度决定附加属性数量
            let additionalCount = 0;
            switch(rarity) {
                case 'common':
                    additionalCount = 0;
                    break;
                case 'rare':
                    additionalCount = 1;
                    break;
                case 'epic':
                    additionalCount = 2;
                    break;
                case 'legendary':
                    additionalCount = 3;
                    break;
            }
            
            // 可选的属性池
            const availableStats = typeData.possibleStats.filter(stat => stat !== typeData.primary);
            
            // 随机选择附加属性
            for (let i = 0; i < additionalCount && availableStats.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * availableStats.length);
                const selectedStat = availableStats[randomIndex];
                
                // 根据属性类型生成值
                let value = 0;
                switch(selectedStat) {
                    case 'attack':
                    case 'defense':
                        value = Math.floor(100 + Math.random() * 100000);
                        break;
                    case 'hp':
                        value = Math.floor(200 + Math.random() * 500000);
                        break;
                    case 'critRate':
                    case 'dodge':
                    case 'lifeSteal':
                    case 'combo':
                        value = Math.floor(10 + Math.random() * 500);
                        break;
                    case 'critDmg':
                        value = Math.floor(10 + Math.random() * 150);
                        break;
                    case 'attackPercent':
                    case 'defensePercent':
                    case 'hpPercent':
                    case 'dodgePercent':
                        value = Math.floor(50 + Math.random() * 1000);
                        break;
                    case 'damageIncrease':
                        value = Math.floor(10 + Math.random() * 100);
                        break;
                }
                
                // 稀有度加成
                const rarityMultiplier = EQUIPMENT_RARITIES.find(r => r.id === rarity).multiplier;
                value = Math.floor(value * rarityMultiplier);
                
                // 添加到属性
                stats[selectedStat] = (stats[selectedStat] || 0) + value;
                
                // 从可用属性中移除，避免重复
                availableStats.splice(randomIndex, 1);
            }
            
            return stats;
        }
        
        // 计算装备价格
        function calculateEquipmentPrice(stats, level, rarityMultiplier) {
            let price = 0;
            
            // 基础价格
            price += level * 10 * rarityMultiplier;
            
            // 属性加成
            for (const stat in stats) {
                let statValue = stats[stat];
                let statWeight = 1;
                
                switch(stat) {
                    case 'attack':
                    case 'defense':
                        statWeight = 2;
                        break;
                    case 'hp':
                        statWeight = 0.1;
                        break;
                    case 'critRate':
                    case 'dodge':
                    case 'lifeSteal':
                    case 'combo':
                        statWeight = 5;
                        break;
                    case 'critDmg':
                        statWeight = 3;
                        break;
                    case 'attackPercent':
                    case 'defensePercent':
                    case 'hpPercent':
                    case 'dodgePercent':
                        statWeight = 10;
                        break;
                    case 'damageIncrease':
                        statWeight = 15;
                        break;
                }
                
                price += statValue * statWeight * rarityMultiplier;
            }
            
            return Math.floor(price);
        }
        
        // 生成装备描述
        function generateEquipmentDescription(name, type, level, rarity, stats) {
            const rarityName = EQUIPMENT_RARITIES.find(r => r.id === rarity).name;
            const typeName = EQUIPMENT_TYPES.find(t => t.id === type).name;
            
            let desc = `一件${rarityName}的${typeName}，等级${level}。`;
            
            // 添加属性描述
            const statEntries = Object.entries(stats);
            if (statEntries.length > 0) {
                desc += ' 拥有';
                statEntries.forEach(([stat, value], index) => {
                    const statName = getStatName(stat);
                    const statSuffix = getStatSuffix(stat);
                    desc += ` ${statName}+${formatNumberWithUnit(value)}${statSuffix}`;
                    if (index < statEntries.length - 1) desc += '，';
                });
                desc += '。';
            }
            
            return desc;
        }
        
        // 获取属性名称
        function getStatName(stat) {
            const statNames = {
                attack: '攻击',
                defense: '防御',
                hp: '生命',
                critRate: '暴击率',
                critDmg: '暴击伤害',
                dodge: '闪避',
                lifeSteal: '吸血',
                combo: '连击',
                attackPercent: '攻击百分比',
                defensePercent: '防御百分比',
                hpPercent: '生命百分比',
                dodgePercent: '闪避百分比',
                damageIncrease: '伤害增加',
                penetration: '穿透'
            };
            
            return statNames[stat] || stat;
        }
        
        // 获取属性后缀
        function getStatSuffix(stat) {
            if (stat.includes('Percent') || stat === 'critRate' || stat === 'dodge' || 
                stat === 'lifeSteal' || stat === 'combo' || stat === 'critDmg') {
                return '%';
            }
            return '';
        }
        
        // 应用装备效果
        function applyEquipmentEffects() {
            let totalAttackBonus = 0;
            let totalDefenseBonus = 0;
            let totalHpBonus = 0;
            
            // 应用所有装备的属性
            for (const slot in GameState.equipment) {
                const equipment = GameState.equipment[slot];
                if (equipment) {
                    // 基础属性
                    if (equipment.attack) {
                        GameState.character.attack += equipment.attack;
                        totalAttackBonus += equipment.attack;
                    }
                    
                    if (equipment.defense) {
                        GameState.character.defense += equipment.defense;
                        totalDefenseBonus += equipment.defense;
                    }
                    
                    if (equipment.hp) {
                        GameState.character.maxHp += equipment.hp;
                        totalHpBonus += equipment.hp;
                    }
                    
                    // 百分比属性
                    if (equipment.attackPercent) {
                        GameState.character.attack *= (1 + equipment.attackPercent / 100);
                        totalAttackBonus += Math.floor(GameState.character.baseAttack * (equipment.attackPercent / 100));
                    }
                    
                    if (equipment.defensePercent) {
                        GameState.character.defense *= (1 + equipment.defensePercent / 100);
                        totalDefenseBonus += Math.floor(GameState.character.baseDefense * (equipment.defensePercent / 100));
                    }
                    
                    if (equipment.hpPercent) {
                        GameState.character.maxHp *= (1 + equipment.hpPercent / 100);
                        totalHpBonus += Math.floor(GameState.character.baseHp * (equipment.hpPercent / 100));
                    }
                    
                    // 其他属性
                    if (equipment.critRate) {
                        GameState.character.critRate += equipment.critRate;
                    }
                    
                    if (equipment.critDmg) {
                        GameState.character.critDmg += equipment.critDmg;
                    }
                    
                    if (equipment.dodge) {
                        GameState.character.dodge += equipment.dodge;
                    }
                    
                    if (equipment.dodgePercent) {
                        GameState.character.dodge *= (1 + equipment.dodgePercent / 100);
                    }
                    
                    if (equipment.lifeSteal) {
                        GameState.character.lifeSteal += equipment.lifeSteal;
                    }
                    
                    if (equipment.combo) {
                        GameState.character.combo += equipment.combo;
                    }
                    
                    // 新增词条
                    if (equipment.damageIncrease) {
                        // 伤害增加效果在战斗计算中处理
                    }
                }
            }
            
            // 更新装备加成显示
            document.getElementById('total-attack-bonus').textContent = formatNumberWithUnit(totalAttackBonus);
            document.getElementById('total-defense-bonus').textContent = formatNumberWithUnit(totalDefenseBonus);
            document.getElementById('total-hp-bonus').textContent = formatNumberWithUnit(totalHpBonus);
            
            document.getElementById('equipment-attack-bonus').textContent = formatNumberWithUnit(totalAttackBonus);
            document.getElementById('equipment-defense-bonus').textContent = formatNumberWithUnit(totalDefenseBonus);
            document.getElementById('equipment-hp-bonus').textContent = formatNumberWithUnit(totalHpBonus);
            
            // 检查套装效果
            checkSetBonus();
        }
        
        // 检查套装效果
        function checkSetBonus() {
            // 统计史诗和传说装备数量
            let epicCount = 0;
            let legendaryCount = 0;
            
            for (const slot in GameState.equipment) {
                const equipment = GameState.equipment[slot];
                if (equipment) {
                    if (equipment.rarity === 'epic') epicCount++;
                    if (equipment.rarity === 'legendary') legendaryCount++;
                }
            }
            
            let setBonus = '无';
            
            // 传说套装效果
            if (legendaryCount >= 4) {
                // 4件传说装备：全属性+5000%
                GameState.character.attack *= 51;
                GameState.character.defense *= 51;
                GameState.character.maxHp *= 51;
                setBonus = '传说套装(+5000%全属性)';
            } else if (epicCount >= 4) {
                // 4件史诗装备：全属性+1500%
                GameState.character.attack *= 16;
                GameState.character.defense *= 16;
                GameState.character.maxHp *= 16;
                setBonus = '史诗套装(+1500%全属性)';
            } else if (epicCount >= 2) {
                setBonus = '2件史诗装备';
            } else if (legendaryCount >= 1) {
                setBonus = '1件传说装备';
            }
            
            document.getElementById('set-bonus').textContent = setBonus;
        }
        
        // 更新装备栏显示
        function updateEquipmentDisplay() {
            const equipmentGrid = document.getElementById('equipment-grid');
            
            // 更新所有装备槽
            for (const slotType in GameState.equipment) {
                const slotElement = equipmentGrid.querySelector(`[data-slot="${slotType}"]`);
                if (!slotElement) continue;
                
                const equipment = GameState.equipment[slotType];
                const typeData = EQUIPMENT_TYPES.find(t => t.id === slotType);
                
                if (equipment && typeData) {
                    slotElement.classList.add('filled');
                    
                    // 获取主属性值
                    let mainStat = '';
                    let mainValue = 0;
                    
                    if (equipment.attack) {
                        mainStat = '攻';
                        mainValue = equipment.attack;
                    } else if (equipment.defense) {
                        mainStat = '防';
                        mainValue = equipment.defense;
                    } else if (equipment.hp) {
                        mainStat = '生';
                        mainValue = equipment.hp;
                    } else if (equipment.critRate) {
                        mainStat = '暴';
                        mainValue = equipment.critRate;
                    }
                    
                    slotElement.innerHTML = `
                        <div class="equipment-icon">${equipment.icon || typeData.icon}</div>
                        <div class="equipment-name">${equipment.name}</div>
                        <div class="equipment-stats">${mainStat}+${formatNumberWithUnit(mainValue)}</div>
                        <div class="long-press-hint">长按脱下</div>
                    `;
                } else {
                    slotElement.classList.remove('filled');
                    slotElement.innerHTML = `
                        <div class="equipment-icon">${typeData ? typeData.icon : '📦'}</div>
                        <div class="equipment-name">${typeData ? typeData.name : '装备'}</div>
                        <div class="equipment-stats">未装备</div>
                        <div class="long-press-hint">长按脱下</div>
                    `;
                }
            }
        }
        
        // 更新背包显示
        function updateInventoryDisplay() {
            const inventoryGrid = document.getElementById('inventory-grid');
            const inventoryCount = document.getElementById('inventory-count');
            
            inventoryGrid.innerHTML = '';
            inventoryCount.textContent = GameState.inventory.length;
            
            // 更新出售按钮状态
            const sellBtn = document.getElementById('sell-equipment-btn');
            
            if (GameState.selectedInventoryItem !== null) {
                sellBtn.disabled = false;
            } else {
                sellBtn.disabled = true;
            }
            
            // 显示背包物品
            GameState.inventory.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = `inventory-item ${GameState.selectedInventoryItem === index ? 'selected' : ''}`;
                itemElement.dataset.index = index;
                
                // 根据稀有度设置颜色
                const rarityData = EQUIPMENT_RARITIES.find(r => r.id === item.rarity);
                const rarityColor = rarityData ? rarityData.color : '#999';
                
                // 获取主属性
                let mainStat = '';
                let mainValue = 0;
                
                if (item.attack) {
                    mainStat = '攻';
                    mainValue = item.attack;
                } else if (item.defense) {
                    mainStat = '防';
                    mainValue = item.defense;
                } else if (item.hp) {
                    mainStat = '生';
                    mainValue = item.hp;
                } else if (item.critRate) {
                    mainStat = '暴';
                    mainValue = item.critRate;
                }
                
                itemElement.innerHTML = `
                    <div class="item-rarity" style="background:${rarityColor}">${rarityData ? rarityData.name : '普通'}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-stats">${mainStat}+${formatNumberWithUnit(mainValue)}</div>
                    <div class="item-type">${EQUIPMENT_TYPES.find(t => t.id === item.type)?.name || '装备'}</div>
                    <div class="item-level">Lv.${item.level}</div>
                `;
                inventoryGrid.appendChild(itemElement);
            });
            
            // 如果背包为空，显示提示
            if (GameState.inventory.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.style.textAlign = 'center';
                emptyMessage.style.color = '#aaa';
                emptyMessage.style.padding = '15px';
                emptyMessage.innerHTML = '背包空空如也<br>击败怪物有几率掉落装备';
                inventoryGrid.appendChild(emptyMessage);
            }
        }
        
        // 添加到背包
        function addToInventory(item) {
            if (GameState.inventory.length >= 30) {
                showNotification('背包已满', '背包空间不足，无法拾取新装备！');
                return false;
            }
            
            // 检查是否应该自动回收
            if (shouldAutoRecycle(item)) {
                autoRecycleItem(item);
                return false;
            }
            
            // 创建装备副本
            const newItem = JSON.parse(JSON.stringify(item));
            GameState.inventory.push(newItem);
            
            // 更新背包显示
            updateInventoryDisplay();
            
            return true;
        }
        
        // 从背包移除物品
        function removeFromInventory(index) {
            if (index >= 0 && index < GameState.inventory.length) {
                GameState.inventory.splice(index, 1);
                
                // 如果移除的是选中的物品，清空选中状态
                if (GameState.selectedInventoryItem === index) {
                    GameState.selectedInventoryItem = null;
                } else if (GameState.selectedInventoryItem > index) {
                    GameState.selectedInventoryItem--;
                }
                
                updateInventoryDisplay();
                return true;
            }
            return false;
        }
        
        // 穿戴装备
        function equipItem(itemIndex) {
            const item = GameState.inventory[itemIndex];
            if (!item) return;
            
            // 脱下当前装备（如果有）
            let oldItem = null;
            oldItem = GameState.equipment[item.type];
            GameState.equipment[item.type] = item;
            
            // 移除背包中的装备
            removeFromInventory(itemIndex);
            
            // 如果有旧装备，放回背包
            if (oldItem) {
                addToInventory(oldItem);
            }
            
            // 重新计算属性
            calculateAttributes();
            
            showNotification('装备穿戴', `你穿上了【${item.name}】！`);
            updateEquipmentDisplay();
            updateInventoryDisplay();
            updateUI();
        }
        
        // 脱下装备
        function unequipItem(slotType) {
            let item = GameState.equipment[slotType];
            GameState.equipment[slotType] = null;
            
            if (item) {
                // 将装备放回背包
                if (addToInventory(item)) {
                    // 重新计算属性
                    calculateAttributes();
                    
                    showNotification('装备脱下', `你脱下了【${item.name}】！`);
                    updateEquipmentDisplay();
                    updateInventoryDisplay();
                    updateUI();
                } else {
                    // 背包已满，恢复装备
                    GameState.equipment[slotType] = item;
                    showNotification('脱下失败', '背包已满，无法脱下装备！');
                }
            }
        }
        
        // 出售装备
        function sellSelectedEquipment() {
            if (GameState.selectedInventoryItem === null) return;
            
            const item = GameState.inventory[GameState.selectedInventoryItem];
            if (!item) return;
            
            const sellPrice = Math.floor(item.price * 0.7);
            
            if (confirm(`确定出售【${item.name}】获得${formatNumberWithUnit(sellPrice)}点灵力吗？`)) {
                GameState.spiritPower += sellPrice;
                removeFromInventory(GameState.selectedInventoryItem);
                
                showNotification('装备出售', `出售【${item.name}】获得${formatNumberWithUnit(sellPrice)}点灵力！`);
                updateUI();
            }
        }
        
        // 显示装备详情
        function showEquipmentDetails(item) {
            const detailsPanel = document.getElementById('equipment-details');
            const detailsContent = document.getElementById('equipment-details-content');
            
            if (!item) {
                detailsPanel.classList.remove('show');
                return;
            }
            
            // 获取稀有度数据
            const rarityData = EQUIPMENT_RARITIES.find(r => r.id === item.rarity);
            const rarityColor = rarityData ? rarityData.color : '#999';
            const rarityName = rarityData ? rarityData.name : '普通';
            
            // 生成属性HTML
            let statsHtml = '';
            const statOrder = ['attack', 'attackPercent', 'defense', 'defensePercent', 'hp', 'hpPercent', 
                               'critRate', 'critDmg', 'dodge', 'dodgePercent', 'lifeSteal', 'combo', 'damageIncrease'];
            
            statOrder.forEach(stat => {
                if (item[stat]) {
                    const statName = getStatName(stat);
                    const statSuffix = getStatSuffix(stat);
                    statsHtml += `<div>${statName}: +${formatNumberWithUnit(item[stat])}${statSuffix}</div>`;
                }
            });
            
            detailsContent.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <div style="font-size: 1.8rem; margin-right: 8px;">${item.icon || '📦'}</div>
                    <div>
                        <div style="font-size: 1.1rem; color: ${rarityColor}; font-weight: bold;">${item.name}</div>
                        <div style="color: ${rarityColor}; font-size: 0.85rem;">${rarityName} · ${EQUIPMENT_TYPES.find(t => t.id === item.type)?.name || '装备'}</div>
                    </div>
                </div>
                <div style="margin-bottom: 8px; color: #666;">${item.desc}</div>
                <div style="margin-bottom: 8px;">
                    <div style="color: #666; font-weight: bold; margin-bottom: 4px;">装备属性:</div>
                    ${statsHtml || '<div>无附加属性</div>'}
                </div>
                <div style="display: flex; justify-content: space-between; color: #888;">
                    <div>等级: ${item.level}</div>
                    <div>出售价格: ${formatNumberWithUnit(Math.floor(item.price * 0.7))}灵力</div>
                </div>
            `;
            
            detailsPanel.classList.add('show');
        }
        
        // 击败怪物时掉落装备
        function dropEquipmentOnMonsterDefeat(monsterLevel) {
            // 掉落概率：基础10% + 怪物等级*20%
            const dropChance = 0.1 + (monsterLevel * 0.2);
            
            if (Math.random() < dropChance) {
                // 随机选择装备类型
                const randomTypeIndex = Math.floor(Math.random() * EQUIPMENT_TYPES.length);
                const equipmentType = EQUIPMENT_TYPES[randomTypeIndex].id;
                
                // 生成装备
                const equipment = generateEquipment(equipmentType, monsterLevel);
                
                if (equipment) {
                    // 添加到背包
                    if (addToInventory(equipment)) {
                        return equipment;
                    }
                }
            }
            
            return null;
        }
        
        // ============================
        // 世界BOSS系统
        // ============================
        
        // 初始化世界BOSS
        function initWorldBoss() {
            // 检查是否需要重置每日挑战次数
            const today = new Date().toDateString();
            if (GameState.worldBoss.lastChallengeDate !== today) {
                GameState.worldBoss.todayChallenges = 0;
                GameState.worldBoss.lastChallengeDate = today;
                GameState.worldBoss.totalDamage = 0;
                
                // 重置奖励阶段状态
                GameState.worldBoss.rewardStages.forEach(stage => {
                    stage.claimed = false;
                });
            }
            
            // 更新BOSS显示
            updateWorldBossDisplay();
            
            // 开始重置计时器
            startBossResetTimer();
        }
        
        // 更新世界BOSS显示
        function updateWorldBossDisplay() {
            document.getElementById('boss-hp').textContent = '∞';
            document.getElementById('boss-attack').textContent = GameState.worldBoss.attack;
            document.getElementById('boss-defense').textContent = formatNumberWithUnit(GameState.worldBoss.defense);
            document.getElementById('boss-total-damage').textContent = formatNumberWithUnit(GameState.worldBoss.totalDamage);
            document.getElementById('boss-today-challenges').textContent = `${GameState.worldBoss.todayChallenges}/${GameState.worldBoss.dailyChallenges}`;
            
            // 更新奖励阶段显示
            updateRewardStagesDisplay();
            
            // 更新领取奖励按钮状态
            const claimBtn = document.getElementById('boss-claim-btn');
            claimBtn.disabled = !hasClaimableRewards();
            
            // 更新挑战按钮状态
            const challengeBtn = document.getElementById('boss-challenge-btn');
            if (GameState.worldBoss.todayChallenges >= GameState.worldBoss.dailyChallenges) {
                challengeBtn.disabled = true;
                challengeBtn.innerHTML = '<i class="fas fa-hourglass-end"></i> 今日次数已用完';
            } else {
                challengeBtn.disabled = false;
                challengeBtn.innerHTML = '<i class="fas fa-fist-raised"></i> 挑战世界BOSS';
            }
        }
        
        // 更新奖励阶段显示
        function updateRewardStagesDisplay() {
            const stagesContainer = document.getElementById('boss-reward-stages');
            const stages = stagesContainer.querySelectorAll('.reward-stage');
            
            stages.forEach(stage => {
                const stageNum = parseInt(stage.dataset.stage);
                const stageData = GameState.worldBoss.rewardStages[stageNum - 1];
                
                if (!stageData) return;
                
                // 更新状态
                stage.className = 'reward-stage';
                const statusElement = stage.querySelector('.stage-status');
                
                if (stageData.claimed) {
                    stage.classList.add('claimed');
                    statusElement.textContent = '已领取';
                    statusElement.className = 'stage-status claimed';
                } else if (GameState.worldBoss.totalDamage >= stageData.damage) {
                    stage.classList.add('claimable');
                    statusElement.textContent = '可领取';
                    statusElement.className = 'stage-status claimable';
                } else {
                    statusElement.textContent = '未达成';
                    statusElement.className = 'stage-status';
                }
            });
        }
        
        // 检查是否有可领取的奖励
        function hasClaimableRewards() {
            return GameState.worldBoss.rewardStages.some(stage => 
                !stage.claimed && GameState.worldBoss.totalDamage >= stage.damage
            );
        }
        
        // 开始BOSS重置计时器
        function startBossResetTimer() {
            // 计算到明天0点的时间
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const timeUntilReset = tomorrow - now;
            
            // 更新显示
            updateBossResetTime(timeUntilReset);
            
            // 设置定时器
            setTimeout(() => {
                initWorldBoss();
                startBossResetTimer();
            }, timeUntilReset);
        }
        
        // 更新BOSS重置时间显示
        function updateBossResetTime(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            document.getElementById('boss-reset-time').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 挑战世界BOSS
        function challengeWorldBoss() {
            if (GameState.worldBoss.todayChallenges >= GameState.worldBoss.dailyChallenges) {
                showNotification('挑战失败', '今日挑战次数已用完！');
                return;
            }
            
            if (!GameState.character.isAlive) {
                showNotification('挑战失败', '角色已阵亡，无法挑战！');
                return;
            }
            
            GameState.worldBoss.todayChallenges++;
            
            // 计算伤害
            let totalDamage = 0;
            let battleLog = '世界BOSS挑战开始！<br>';
            
            // 模拟500次攻击
            for (let i = 0; i < 500; i++) {
                // 计算暴击
                let isCrit = Math.random() < (GameState.character.critRate / 100);
                let critMultiplier = isCrit ? GameState.character.critDmg / 100 : 1;
                
                // 计算增伤效果
                let damageMultiplier = 1;
                for (const slot in GameState.equipment) {
                    const equipment = GameState.equipment[slot];
                    if (equipment && equipment.damageIncrease) {
                        damageMultiplier += equipment.damageIncrease / 100;
                    }
                }
                
                // 计算基础伤害
                const baseDamage = Math.floor(
                    GameState.character.attack * (0.8 + Math.random() * 0.4)
                );
                
                // 应用暴击和增伤
                let damage = Math.floor(baseDamage * critMultiplier * damageMultiplier);
                
                // 应用穿透效果（降低BOSS防御）
                const effectiveDefense = Math.max(0, GameState.worldBoss.defense * (1 - GameState.character.penetration / 100));
                
                // 最终伤害计算
                const finalDamage = Math.max(1, damage - effectiveDefense);
                totalDamage += finalDamage;
                
                // 记录战斗日志
                battleLog += `第${i+1}击: ${formatNumberWithUnit(finalDamage)}点伤害`;
                if (isCrit) battleLog += ' (暴击!)';
                if (damageMultiplier > 1) battleLog += ` (增伤x${damageMultiplier.toFixed(2)})`;
                battleLog += '<br>';
                
                // 吸血效果
                if (GameState.character.lifeSteal > 0) {
                    const healAmount = Math.floor(finalDamage * (GameState.character.lifeSteal / 100));
                    GameState.character.hp = Math.min(GameState.character.hp + healAmount, GameState.character.maxHp);
                }
            }
            
            // 减少BOSS血量（无穷血量，不会减少）
            GameState.worldBoss.totalDamage += totalDamage;
            
            // 更新显示
            battleLog += `<br>本次挑战造成总伤害: ${formatNumberWithUnit(totalDamage)}`;
            document.getElementById('battle-info').innerHTML = battleLog;
            
            // 更新UI
            updateWorldBossDisplay();
            updateUI();
            
            // 保存游戏
            saveGame();
        }
        
        // 领取世界BOSS奖励
        function claimWorldBossReward() {
            if (!hasClaimableRewards()) {
                showNotification('领取失败', '没有可领取的奖励！');
                return;
            }
            
            let totalReward = 0;
            let claimedCount = 0;
            
            // 领取所有可领取的奖励
            GameState.worldBoss.rewardStages.forEach(stage => {
                if (!stage.claimed && GameState.worldBoss.totalDamage >= stage.damage) {
                    stage.claimed = true;
                    totalReward += stage.reward;
                    claimedCount++;
                }
            });
            
            GameState.spiritPower += totalReward;
            
            showNotification('奖励领取', `领取了${claimedCount}个阶段的奖励，共获得${formatNumberWithUnit(totalReward)}点灵力！`);
            updateWorldBossDisplay();
            updateUI();
        }
        
        // ============================
        // 自动回收系统
        // ============================
        
        // 初始化自动回收设置
        function initAutoRecycle() {
            // 从本地存储加载设置
            const savedSettings = localStorage.getItem('cultivation_auto_recycle');
            if (savedSettings) {
                try {
                    GameState.autoRecycle = JSON.parse(savedSettings);
                } catch (e) {
                    console.error('加载自动回收设置失败:', e);
                }
            }
            
            // 更新UI
            updateAutoRecycleUI();
        }
        
        // 更新自动回收UI
        function updateAutoRecycleUI() {
            document.getElementById('recycle-level').value = GameState.autoRecycle.levelThreshold;
            document.getElementById('recycle-rarity').value = GameState.autoRecycle.rarityThreshold;
            document.getElementById('total-recycled-spirit').textContent = formatNumberWithUnit(GameState.autoRecycle.totalRecycledSpirit);
            document.getElementById('total-recycled-items').textContent = formatNumberWithUnit(GameState.autoRecycle.totalRecycledItems);
        }
        
        // 检查是否应该自动回收
        function shouldAutoRecycle(item) {
            // 检查等级阈值
            if (GameState.autoRecycle.levelThreshold > 0 && item.level < GameState.autoRecycle.levelThreshold) {
                return true;
            }
            
            // 检查稀有度阈值
            if (GameState.autoRecycle.rarityThreshold !== 'none') {
                const rarityOrder = ['common', 'rare', 'epic', 'legendary'];
                const itemRarityIndex = rarityOrder.indexOf(item.rarity);
                const thresholdRarityIndex = rarityOrder.indexOf(GameState.autoRecycle.rarityThreshold);
                
                if (itemRarityIndex <= thresholdRarityIndex) {
                    return true;
                }
            }
            
            return false;
        }
        
        // 自动回收装备
        function autoRecycleItem(item) {
            const sellPrice = Math.floor(item.price * 0.7);
            GameState.spiritPower += sellPrice;
            GameState.autoRecycle.totalRecycledSpirit += sellPrice;
            GameState.autoRecycle.totalRecycledItems++;
            
            // 显示通知
            showNotification('自动回收', `自动回收【${item.name}】获得${formatNumberWithUnit(sellPrice)}点灵力！`);
            
            // 更新UI
            updateAutoRecycleUI();
            updateUI();
            
            return true;
        }
        
        // 手动回收背包
        function manualRecycleBackpack() {
            let recycledCount = 0;
            let totalSpirit = 0;
            
            // 从后往前遍历，避免索引问题
            for (let i = GameState.inventory.length - 1; i >= 0; i--) {
                const item = GameState.inventory[i];
                
                // 检查是否应该回收
                if (shouldAutoRecycle(item)) {
                    const sellPrice = Math.floor(item.price * 0.7);
                    totalSpirit += sellPrice;
                    recycledCount++;
                    
                    // 从背包移除
                    removeFromInventory(i);
                }
            }
            
            if (recycledCount > 0) {
                GameState.spiritPower += totalSpirit;
                GameState.autoRecycle.totalRecycledSpirit += totalSpirit;
                GameState.autoRecycle.totalRecycledItems += recycledCount;
                
                showNotification('背包回收', `回收了${recycledCount}件装备，获得${formatNumberWithUnit(totalSpirit)}点灵力！`);
                
                // 更新UI
                updateAutoRecycleUI();
                updateUI();
            } else {
                showNotification('背包回收', '没有符合条件的装备可以回收！');
            }
        }
        
        // 保存自动回收设置
        function saveAutoRecycleSettings() {
            // 获取当前设置
            GameState.autoRecycle.levelThreshold = parseInt(document.getElementById('recycle-level').value);
            GameState.autoRecycle.rarityThreshold = document.getElementById('recycle-rarity').value;
            
            // 保存到本地存储
            try {
                localStorage.setItem('cultivation_auto_recycle', JSON.stringify(GameState.autoRecycle));
                showNotification('设置保存', '自动回收设置已保存！');
            } catch (e) {
                showNotification('保存失败', '保存设置失败，请检查浏览器设置');
            }
        }
        
        // ============================
        // 天赋系统
        // ============================
        
        // 刷新天赋
        function refreshBuffs() {
            if (GameState.refreshCount <= 0) {
                showNotification('刷新失败', '刷新次数已用完！');
                return;
            }
            
            GameState.refreshCount--;
            
            // 保留锁定的天赋
            const lockedBuffs = GameState.buffs.filter(buff => buff.locked);
            
            // 计算需要刷新的数量
            const refreshCount = 9 - lockedBuffs.length;
            
            // 获取当前已存在天赋的ID（包括锁定的和选中的）
            const existingBuffIds = new Set();
            lockedBuffs.forEach(buff => existingBuffIds.add(buff.id));
            GameState.selectedBuffs.forEach(buff => existingBuffIds.add(buff.id));
            
            // 随机选择新BUFF（按权重），确保不重复
            const newBuffs = [...lockedBuffs];
            for (let i = 0; i < refreshCount; i++) {
                const rand = Math.random() * 100;
                let rarity;
                
                if (rand < RARITY_WEIGHTS.legendary) rarity = 'legendary';
                else if (rand < RARITY_WEIGHTS.legendary + RARITY_WEIGHTS.epic) rarity = 'epic';
                else if (rand < RARITY_WEIGHTS.legendary + RARITY_WEIGHTS.epic + RARITY_WEIGHTS.rare) rarity = 'rare';
                else rarity = 'common';
                
                // 筛选该稀有度且不在现有天赋中的BUFF
                const availableBuffs = BUFF_POOL.filter(buff => 
                    buff.rarity === rarity && !existingBuffIds.has(buff.id)
                );
                
                // 如果该稀有度没有可用天赋，选择任意稀有度但不在现有天赋中的BUFF
                if (availableBuffs.length === 0) {
                    const fallbackBuffs = BUFF_POOL.filter(buff => !existingBuffIds.has(buff.id));
                    if (fallbackBuffs.length > 0) {
                        const randomBuff = {...fallbackBuffs[Math.floor(Math.random() * fallbackBuffs.length)]};
                        randomBuff.selected = GameState.selectedBuffs.some(b => b.id === randomBuff.id);
                        randomBuff.locked = false;
                        newBuffs.push(randomBuff);
                        existingBuffIds.add(randomBuff.id);
                    }
                } else {
                    const randomBuff = {...availableBuffs[Math.floor(Math.random() * availableBuffs.length)]};
                    randomBuff.selected = GameState.selectedBuffs.some(b => b.id === randomBuff.id);
                    randomBuff.locked = false;
                    newBuffs.push(randomBuff);
                    existingBuffIds.add(randomBuff.id);
                }
            }
            
            GameState.buffs = newBuffs;
            updateBuffsDisplay();
            updateUI();
            
            // 更新开始按钮状态
            document.getElementById('start-btn').disabled = GameState.selectedBuffs.length < 2;
        }
        
        // 选择/取消选择天赋
        function toggleBuffSelection(buffIndex) {
            const buff = GameState.buffs[buffIndex];
            if (!buff) return;
            
            // 切换选择状态
            buff.selected = !buff.selected;
            
            if (buff.selected) {
                // 添加到已选
                if (GameState.selectedBuffs.length < 2) {
                    // 确保同一个天赋不会重复选择
                    if (!GameState.selectedBuffs.some(b => b.id === buff.id)) {
                        GameState.selectedBuffs.push(buff);
                    }
                } else {
                    // 如果已选两个，取消选择
                    buff.selected = false;
                    showNotification('选择限制', '最多只能选择两个天赋');
                    return;
                }
            } else {
                // 从已选中移除
                const buffIndexInSelected = GameState.selectedBuffs.findIndex(b => b.id === buff.id);
                if (buffIndexInSelected !== -1) {
                    GameState.selectedBuffs.splice(buffIndexInSelected, 1);
                }
            }
            
            // 更新显示
            updateBuffsDisplay();
            
            // 更新开始按钮状态
            document.getElementById('start-btn').disabled = GameState.selectedBuffs.length < 2;
        }
        
        // 锁定/解锁天赋
        function toggleBuffLock(buffIndex) {
            const buff = GameState.buffs[buffIndex];
            if (!buff) return;
            
            buff.locked = !buff.locked;
            
            // 更新显示
            updateBuffsDisplay();
        }
        
        // 获取稀有度名称
        function getRarityName(rarity) {
            switch(rarity) {
                case 'common': return '普通';
                case 'rare': return '稀有';
                case 'epic': return '史诗';
                case 'legendary': return '传说';
                case 'mythic': return '神话';
                default: return '未知';
            }
        }
        
        // 更新天赋显示
        function updateBuffsDisplay() {
            const buffContainer = document.getElementById('buff-container');
            buffContainer.innerHTML = '';
            
            GameState.buffs.forEach((buff, index) => {
                const buffElement = document.createElement('div');
                buffElement.className = `buff-card ${buff.rarity} ${buff.selected ? 'selected' : ''}`;
                buffElement.dataset.index = index;
                buffElement.innerHTML = `
                    <div class="lock-icon ${buff.locked ? 'locked' : ''}"><i class="fas ${buff.locked ? 'fa-lock' : 'fa-lock-open'}"></i></div>
                    <div class="buff-rarity">${getRarityName(buff.rarity)}</div>
                    <div class="buff-name">${buff.name}</div>
                    <div class="buff-desc">${buff.desc}</div>
                    <div class="buff-select">已选择</div>
                `;
                buffContainer.appendChild(buffElement);
            });
            
            // 更新已选天赋显示
            updateSelectedBuffsDisplay();
        }
        
        // 更新已选天赋显示
        function updateSelectedBuffsDisplay() {
            const selectedBuffsGrid = document.getElementById('selected-buffs-grid');
            selectedBuffsGrid.innerHTML = '';
            
            GameState.selectedBuffs.forEach((buff, index) => {
                const buffElement = document.createElement('div');
                buffElement.className = `buff-card ${buff.rarity} selected`;
                buffElement.innerHTML = `
                    <div class="buff-rarity">${getRarityName(buff.rarity)}</div>
                    <div class="buff-name">${buff.name}</div>
                    <div class="buff-desc">${buff.desc}</div>
                `;
                selectedBuffsGrid.appendChild(buffElement);
            });
            
            // 更新已选天赋数量
            document.getElementById('selected-buffs-count').textContent = GameState.selectedBuffs.length;
        }
        
        // ============================
        // 战斗系统
        // ============================
        
        // 处理战斗动作
        function handleBattleAction(action) {
            if (!GameState.character.isAlive) return;
            
            switch(action) {
                case 'attack':
                    performAttack();
                    break;
            }
        }
        
        // 执行攻击
        function performAttack() {
            let totalDamage = 0;
            let comboCount = 1;
            let battleLog = '';
            
            // 检查连击
            if (Math.random() < (GameState.character.combo / 100)) {
                comboCount = 2 + Math.floor(Math.random() * 3);
                battleLog += `<div class="combo-hit">触发连击！将进行${comboCount}次攻击！</div>`;
            }
            
            for (let i = 0; i < comboCount; i++) {
                // 计算暴击
                let isCrit = Math.random() < (GameState.character.critRate / 100);
                let critMultiplier = isCrit ? GameState.character.critDmg / 100 : 1;
                
                // 计算增伤效果
                let damageMultiplier = 1;
                for (const slot in GameState.equipment) {
                    const equipment = GameState.equipment[slot];
                    if (equipment && equipment.damageIncrease) {
                        damageMultiplier += equipment.damageIncrease / 100;
                    }
                }
                
                // 计算基础伤害
                const baseDamage = Math.floor(
                    GameState.character.attack * (0.8 + Math.random() * 0.4)
                );
                
                // 应用暴击和增伤
                let damage = Math.floor(baseDamage * critMultiplier * damageMultiplier);
                
                // 应用穿透效果
                const effectiveDefense = Math.max(0, GameState.monster.defense * (1 - GameState.character.penetration / 100));
                
                // 最终伤害
                const finalDamage = Math.max(1, damage - effectiveDefense);
                GameState.monster.hp -= finalDamage;
                totalDamage += finalDamage;
                
                if (GameState.monster.hp < 0) GameState.monster.hp = 0;
                
                // 记录每次攻击
                let hitClass = isCrit ? 'combo-hit crit' : 'combo-hit';
                battleLog += `<div class="${hitClass}">第${i+1}击: ${formatNumberWithUnit(finalDamage)}点伤害`;
                if (isCrit) battleLog += ' (暴击!)';
                if (damageMultiplier > 1) battleLog += ` (增伤x${damageMultiplier.toFixed(2)})`;
                battleLog += '</div>';
                
                // 吸血效果
                if (GameState.character.lifeSteal > 0) {
                    const healAmount = Math.floor(finalDamage * (GameState.character.lifeSteal / 100));
                    GameState.character.hp = Math.min(GameState.character.hp + healAmount, GameState.character.maxHp);
                }
                
                // 如果怪物死亡，跳出循环
                if (GameState.monster.hp <= 0) {
                    break;
                }
            }
            
            // 更新战斗日志
            document.getElementById('battle-info').innerHTML = battleLog;
            
            setTimeout(() => {
                if (GameState.monster.hp <= 0) {
                    defeatMonster();
                } else {
                    const isDodge = Math.random() < (GameState.character.dodge / 100);
                    
                    if (isDodge) {
                        document.getElementById('battle-info').innerHTML += `<div class="combo-hit">${GameState.monster.name}发动攻击，但你成功闪避了！</div>`;
                    } else {
                        // 伤害计算公式
                        let monsterDamage = Math.floor(
                            GameState.monster.attack - 1.33 * GameState.character.defense
                        );
                        
                        // 如果伤害小于1，则强制为1
                        if (monsterDamage < 1) monsterDamage = 1;
                        
                        GameState.character.hp -= monsterDamage;
                        
                        if (GameState.character.hp <= 0) {
                            GameState.character.hp = 0;
                            GameState.character.isAlive = false;
                            document.getElementById('battle-info').innerHTML += `<div class="combo-hit crit">${GameState.monster.name}发动致命一击，你已阵亡！</div>`;
                            startResurrection();
                        } else {
                            document.getElementById('battle-info').innerHTML += `<div class="combo-hit">${GameState.monster.name}发动攻击，对你造成 ${formatNumberWithUnit(monsterDamage)} 点伤害！</div>`;
                            document.getElementById('battle-info').innerHTML += `<div class="combo-hit">${GameState.monster.name}气血剩余 ${formatNumberWithUnit(GameState.monster.hp)}/${formatNumberWithUnit(GameState.monster.maxHp)}</div>`;
                        }
                    }
                }
                updateUI();
            }, 800);
        }
        
        // 击败怪物
        function defeatMonster() {
            const spiritReward = Math.floor(
                GameState.monster.rewardMin + 
                Math.random() * (GameState.monster.rewardMax - GameState.monster.rewardMin)
            );
            GameState.spiritPower += spiritReward;
            GameState.monsterDefeated++;
            
            // 经验值
            GameState.character.experience += 10 * GameState.monster.level;
            checkLevelUp();
            
            document.getElementById('battle-info').innerHTML += `<div class="combo-hit">${GameState.monster.name}已被击败！获得 ${formatNumberWithUnit(spiritReward)} 点灵力</div>`;
            
            // 随机掉落装备
            const droppedEquipment = dropEquipmentOnMonsterDefeat(GameState.monster.level);
            if (droppedEquipment) {
                document.getElementById('battle-info').innerHTML += `<div class="combo-hit">${GameState.monster.name}掉落了【${droppedEquipment.name}】！</div>`;
            }
            
            setTimeout(() => {
                loadMonster(GameState.monster.level);
                document.getElementById('battle-info').innerHTML = `<div class="combo-hit">新的${GameState.monster.name}出现了！</div>`;
                updateUI();
            }, 1000);
        }
        
        // 检查升级
        function checkLevelUp() {
            const requiredExp = GameState.character.level * 100;
            if (GameState.character.experience >= requiredExp) {
                GameState.character.level++;
                GameState.character.experience -= requiredExp;
                
                // 升级奖励
                GameState.character.baseHp += 50;
                GameState.character.baseAttack += 5;
                GameState.character.baseDefense += 2;
                
                calculateAttributes();
                
                showNotification('等级提升', `恭喜升到${GameState.character.level}级！全属性提升！`);
                updateUI();
            }
        }
        
        // ============================
        // 修仙系统
        // ============================
        
        // 开始修炼
        function startCultivation() {
            // 清除之前的定时器
            if (GameState.cultivationInterval) {
                clearInterval(GameState.cultivationInterval);
            }
            
            // 每5秒增加灵力
            GameState.cultivationInterval = setInterval(() => {
                // 计算境界加成
                const stageBonus = GameState.stageBonuses[GameState.cultivationStage] || 0;
                const stageMultiplier = 1 + (stageBonus / 100);
                
                // 计算天赋加成
                let rewardMultiplier = 1;
                GameState.selectedBuffs.forEach(buff => {
                    if (buff.effect === "spiritGain") {
                        rewardMultiplier += buff.value;
                    }
                });
                
                const actualReward = Math.round(GameState.stageReward * stageMultiplier * rewardMultiplier);
                GameState.spiritPower += actualReward;
                
                updateUI();
            }, 5000);
        }
        
        // 闭关修炼
        function handleCultivation() {
            // 计算修炼消耗
            const cultivationCost = GameState.cultivationCosts[GameState.cultivationStage] || 100;
            
            if (GameState.spiritPower < cultivationCost) {
                showNotification('修炼失败', `灵力不足，需要至少${formatNumberWithUnit(cultivationCost)}点灵力进行闭关！`);
                return;
            }
            
            GameState.spiritPower -= cultivationCost;
            
            // 计算修炼速度加成
            let cultivationSpeed = 1;
            GameState.selectedBuffs.forEach(buff => {
                if (buff.effect === "cultivationSpeed") {
                    cultivationSpeed += buff.value;
                }
            });
            
            // 增加修炼进度
            const progressGain = Math.floor((5 + Math.floor(Math.random() * 10)) * cultivationSpeed);
            GameState.cultivationProgress += progressGain;
            
            if (GameState.cultivationProgress >= 100) {
                // 进阶到下一境界
                const currentIndex = CULTIVATION_STAGES.indexOf(GameState.cultivationStage);
                
                if (currentIndex < CULTIVATION_STAGES.length - 1) {
                    GameState.cultivationStage = CULTIVATION_STAGES[currentIndex + 1];
                    GameState.cultivationProgress = 0;
                    
                    // 提升角色基础属性
                    GameState.character.baseHp += 50;
                    GameState.character.baseAttack += 5;
                    GameState.character.baseDefense += 2;
                    
                    // 体质增加
                    if (currentIndex % 3 === 0) {
                        GameState.character.baseConstitution += 10;
                        showNotification('体质提升', `突破境界使你的体质永久提升了10点！`);
                    }
                    
                    // 重新计算属性
                    calculateAttributes();
                    
                    showNotification('境界突破', `恭喜！你已突破到${CULTIVATION_STAGES[currentIndex + 1]}！`);
                } else {
                    GameState.cultivationProgress = 100;
                    showNotification('大圆满', '恭喜！你已达到大圆满境界！');
                }
            }
            
            showNotification('闭关修炼', `你闭关修炼获得了${progressGain}%的进度！消耗${formatNumberWithUnit(cultivationCost)}灵力`);
            updateUI();
        }
        
        // ============================
        // 辅助功能
        // ============================
        
        // 更新UI
        function updateUI() {
            // 更新基础信息
            document.getElementById('refresh-count').textContent = GameState.refreshCount;
            document.getElementById('refresh-counter').textContent = GameState.refreshCount;
            
            // 更新灵力显示
            document.getElementById('spirit-power').textContent = formatNumberWithUnit(GameState.spiritPower);
            document.getElementById('available-spirit').textContent = formatNumberWithUnit(GameState.spiritPower);
            
            // 更新等级进度
            const levelProgress = Math.min(100, (GameState.character.experience / (GameState.character.level * 100)) * 100);
            document.getElementById('progress-fill').style.width = `${levelProgress}%`;
            document.getElementById('progress-text').textContent = 
                `等级 ${GameState.character.level} · ${levelProgress.toFixed(1)}%`;
            document.getElementById('stage-progress-value').textContent = levelProgress.toFixed(1);
            
            // 更新境界修炼进度
            document.getElementById('cultivation-progress-fill').style.width = `${GameState.cultivationProgress}%`;
            document.getElementById('cultivation-progress-text').textContent = 
                `${GameState.cultivationStage} · ${GameState.cultivationProgress}%`;
            document.getElementById('cultivation-progress-value').textContent = GameState.cultivationProgress;
            
            // 更新怪物信息
            document.getElementById('monster-name').textContent = GameState.monster.name;
            document.getElementById('monster-hp').textContent = formatNumberWithUnit(GameState.monster.hp);
            document.getElementById('monster-attack').textContent = formatNumberWithUnit(GameState.monster.attack);
            document.getElementById('monster-defense').textContent = formatNumberWithUnit(GameState.monster.defense);
            document.getElementById('monster-cultivation').textContent = GameState.monster.cultivation;
            
            // 更新角色信息
            document.getElementById('character-stage').textContent = GameState.cultivationStage;
            document.getElementById('character-level').textContent = GameState.character.level;
            document.getElementById('character-hp').textContent = `${formatNumberWithUnit(Math.floor(GameState.character.hp))}/${formatNumberWithUnit(Math.floor(GameState.character.maxHp))}`;
            document.getElementById('character-attack').textContent = formatNumberWithUnit(Math.floor(GameState.character.attack));
            document.getElementById('character-defense').textContent = formatNumberWithUnit(Math.floor(GameState.character.defense));
            document.getElementById('character-crit-rate').textContent = `${Math.min(100, Math.floor(GameState.character.critRate))}%`;
            document.getElementById('character-crit-dmg').textContent = `${Math.floor(GameState.character.critDmg)}%`;
            document.getElementById('character-dodge').textContent = `${Math.min(80, Math.floor(GameState.character.dodge))}%`;
            document.getElementById('character-lifeSteal').textContent = `${Math.min(80, Math.floor(GameState.character.lifeSteal))}%`;
            document.getElementById('character-combo').textContent = `${Math.min(80, Math.floor(GameState.character.combo))}%`;
            document.getElementById('character-constitution').textContent = formatNumberWithUnit(Math.floor(GameState.character.constitution));
            
            // 更新属性面板
            document.getElementById('attack-value').textContent = formatNumberWithUnit(Math.floor(GameState.character.baseAttack));
            document.getElementById('defense-value').textContent = formatNumberWithUnit(Math.floor(GameState.character.baseDefense));
            document.getElementById('hp-value').textContent = formatNumberWithUnit(Math.floor(GameState.character.baseHp));
            document.getElementById('constitution-value').textContent = formatNumberWithUnit(Math.floor(GameState.character.baseConstitution));
            
            // 更新属性加点消耗
            const attackCost = GameState.attributeCosts.attack.base + (GameState.attributeCosts.attack.level * GameState.attributeCosts.attack.increment);
            const defenseCost = GameState.attributeCosts.defense.base + (GameState.attributeCosts.defense.level * GameState.attributeCosts.defense.increment);
            const hpCost = GameState.attributeCosts.hp.base + (GameState.attributeCosts.hp.level * GameState.attributeCosts.hp.increment);
            const constitutionCost = GameState.attributeCosts.constitution.base + (GameState.attributeCosts.constitution.level * GameState.attributeCosts.constitution.increment);
            
            document.getElementById('attack-cost').textContent = formatNumberWithUnit(attackCost);
            document.getElementById('defense-cost').textContent = formatNumberWithUnit(defenseCost);
            document.getElementById('hp-cost').textContent = formatNumberWithUnit(hpCost);
            document.getElementById('constitution-cost').textContent = formatNumberWithUnit(constitutionCost);
            
            // 更新挂机状态
            const stageBonus = GameState.stageBonuses[GameState.cultivationStage] || 0;
            const stageMultiplier = 1 + (stageBonus / 100);
            let rewardMultiplier = 1;
            GameState.selectedBuffs.forEach(buff => {
                if (buff.effect === "spiritGain") {
                    rewardMultiplier += buff.value;
                }
            });
            
            const actualReward = Math.round(GameState.stageReward * stageMultiplier * rewardMultiplier);
            document.getElementById('current-reward').textContent = formatNumberWithUnit(actualReward);
            document.getElementById('spirit-per-minute').textContent = formatNumberWithUnit(actualReward);
            
            // 更新境界显示
            document.getElementById('current-stage').textContent = GameState.cultivationStage;
            document.getElementById('current-stage-display').textContent = GameState.cultivationStage;
            
            // 更新击败怪物数
            document.getElementById('monster-defeated').textContent = formatNumberWithUnit(GameState.monsterDefeated);
            
            // 更新游戏时间
            document.getElementById('game-time').textContent = formatTime(GameState.gameTime);
            
            // 更新最后保存时间
            if (GameState.lastSaveTime) {
                document.getElementById('last-save').textContent = new Date(GameState.lastSaveTime).toLocaleTimeString().slice(0,5);
                document.getElementById('save-time').textContent = new Date(GameState.lastSaveTime).toLocaleString();
            } else {
                document.getElementById('save-time').textContent = '未保存';
            }
            
            // 更新自动战斗按钮状态
            const autoBattleBtn = document.getElementById('auto-battle-btn');
            if (GameState.autoBattleActive) {
                autoBattleBtn.classList.add('active');
                autoBattleBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动战斗';
            } else {
                autoBattleBtn.classList.remove('active');
                autoBattleBtn.innerHTML = '<i class="fas fa-robot"></i> 自动战斗';
            }
            
            // 更新修炼速度显示
            let cultivationSpeed = 100;
            GameState.selectedBuffs.forEach(buff => {
                if (buff.effect === "cultivationSpeed") {
                    cultivationSpeed += buff.value * 100;
                }
            });
            document.getElementById('character-cultivation-speed').textContent = `${cultivationSpeed}%`;
            
            // 更新战斗状态显示
            document.getElementById('player-hp-display').textContent = `${formatNumberWithUnit(Math.floor(GameState.character.hp))}/${formatNumberWithUnit(Math.floor(GameState.character.maxHp))}`;
            document.getElementById('monster-hp-display').textContent = `${formatNumberWithUnit(GameState.monster.hp)}/${formatNumberWithUnit(GameState.monster.maxHp)}`;
        }
        
        // 开始复活倒计时
        function startResurrection() {
            const resurrectOverlay = document.getElementById('resurrect-overlay');
            const resurrectTimer = document.getElementById('resurrect-timer');
            resurrectOverlay.style.display = 'flex';
            
            // 禁用战斗按钮
            document.getElementById('attack-btn').disabled = true;
            document.getElementById('auto-battle-btn').disabled = true;
            
            let timeLeft = 5;
            resurrectTimer.textContent = timeLeft;
            
            const countdown = setInterval(() => {
                timeLeft--;
                resurrectTimer.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    resurrectOverlay.style.display = 'none';
                    GameState.character.isAlive = true;
                    GameState.character.hp = GameState.character.maxHp;
                    
                    // 启用战斗按钮
                    document.getElementById('attack-btn').disabled = false;
                    document.getElementById('auto-battle-btn').disabled = false;
                    
                    document.getElementById('battle-info').innerHTML = '<div class="combo-hit">你已复活，生命值恢复满！</div>';
                    updateUI();
                }
            }, 1000);
        }
        
        // 加载怪物
        function loadMonster(level) {
            GameState.monster = {...MONSTERS_BY_LEVEL[level]};
            GameState.monster.level = level;
            GameState.monster.hp = GameState.monster.maxHp;
            updateUI();
        }
        
        // 初始化怪物选项
        function initMonsterOptions() {
            const monsterSelection = document.getElementById('monster-selection');
            monsterSelection.innerHTML = '';
            
            for (let level = 1; level <= 20; level++) {
                const monster = MONSTERS_BY_LEVEL[level];
                if (!monster) continue;
                
                const option = document.createElement('div');
                option.className = `monster-option ${level === 1 ? 'selected' : ''}`;
                option.dataset.level = level;
                option.innerHTML = `
                    <div class="monster-level">${monster.cultivation}妖兽</div>
                    <div class="monster-reward">灵力奖励: ${formatNumberWithUnit(monster.rewardMin)}-${formatNumberWithUnit(monster.rewardMax)}</div>
                `;
                monsterSelection.appendChild(option);
            }
        }
        
        // 加点属性
        function addAttribute(attr) {
            const costInfo = GameState.attributeCosts[attr];
            const cost = costInfo.base + (costInfo.level * costInfo.increment);
            
            if (GameState.spiritPower < cost) {
                showNotification('加点失败', `灵力不足，需要${formatNumberWithUnit(cost)}点灵力！`);
                return;
            }
            
            GameState.spiritPower -= cost;
            
            // 增加基础属性
            switch(attr) {
                case 'attack':
                    GameState.character.baseAttack += 5;
                    costInfo.level++;
                    break;
                case 'defense':
                    GameState.character.baseDefense += 2;
                    costInfo.level++;
                    break;
                case 'hp':
                    GameState.character.baseHp += 20;
                    GameState.character.hp += 20;
                    costInfo.level++;
                    break;
                case 'critRate':
                    GameState.character.baseCritRate += 1;
                    costInfo.level++;
                    break;
                case 'critDmg':
                    GameState.character.baseCritDmg += 10;
                    costInfo.level++;
                    break;
                case 'dodge':
                    GameState.character.baseDodge += 1;
                    costInfo.level++;
                    break;
                case 'lifeSteal':
                    GameState.character.baseLifeSteal += 1;
                    costInfo.level++;
                    break;
                case 'combo':
                    GameState.character.baseCombo += 1;
                    costInfo.level++;
                    break;
                case 'constitution':
                    GameState.character.baseConstitution += 1;
                    costInfo.level++;
                    break;
            }
            
            // 重新计算属性
            calculateAttributes();
            
            showNotification('属性提升', `${getAttributeName(attr)}提升了！`);
            updateUI();
        }
        
        // 获取属性名称
        function getAttributeName(attr) {
            switch(attr) {
                case 'attack': return '攻击力';
                case 'defense': return '防御力';
                case 'hp': return '生命值';
                case 'critRate': return '暴击率';
                case 'critDmg': return '暴击伤害';
                case 'dodge': return '闪避率';
                case 'lifeSteal': return '吸血率';
                case 'combo': return '连击率';
                case 'constitution': return '体质';
                default: return '';
            }
        }
        
        // 自动战斗
        function toggleAutoBattle() {
            if (!GameState.character.isAlive) return;
            
            GameState.autoBattleActive = !GameState.autoBattleActive;
            
            if (GameState.autoBattleActive) {
                // 开始自动战斗
                document.getElementById('battle-info').innerHTML = '<div class="combo-hit">自动战斗已启动！</div>';
                GameState.autoBattleInterval = setInterval(() => {
                    if (!GameState.character.isAlive || !GameState.autoBattleActive) {
                        toggleAutoBattle();
                        return;
                    }
                    
                    // 执行攻击
                    performAttack();
                }, 2000);
            } else {
                // 停止自动战斗
                document.getElementById('battle-info').innerHTML = '<div class="combo-hit">自动战斗已停止！</div>';
                clearInterval(GameState.autoBattleInterval);
                GameState.autoBattleInterval = null;
            }
            
            updateUI();
        }
        
        // ============================
        // 存档/读档系统
        // ============================
        
        // 保存游戏
        function saveGame() {
            const saveData = {
                version: GameState.VERSION,
                spiritPower: GameState.spiritPower,
                cultivationStage: GameState.cultivationStage,
                stageProgress: GameState.stageProgress,
                cultivationProgress: GameState.cultivationProgress,
                selectedBuffs: GameState.selectedBuffs,
                character: GameState.character,
                monsterDefeated: GameState.monsterDefeated,
                gameTime: GameState.gameTime,
                equipment: GameState.equipment,
                inventory: GameState.inventory,
                autoRecycle: GameState.autoRecycle,
                worldBoss: GameState.worldBoss,
                attributeCosts: GameState.attributeCosts,
                settings: GameState.settings,
                lastSaveTime: Date.now()
            };
            
            try {
                localStorage.setItem('cultivation_save', JSON.stringify(saveData));
                GameState.lastSaveTime = Date.now();
                showSaveNotification();
                showNotification('游戏保存', '游戏进度已保存！');
                updateUI();
            } catch (e) {
                showNotification('保存失败', '保存游戏数据失败，请检查浏览器设置');
            }
        }
        
        // 显示存档提示
        function showSaveNotification() {
            const saveNotification = document.getElementById('save-notification');
            saveNotification.classList.add('show');
            
            setTimeout(() => {
                saveNotification.classList.remove('show');
            }, 2000);
        }
        
        // 加载游戏
        function loadGameData() {
            try {
                const savedData = localStorage.getItem('cultivation_save');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // 检查版本兼容性
                    if (data.version && data.version.startsWith('5.')) {
                        // 加载数据
                        GameState.spiritPower = data.spiritPower || 0;
                        GameState.cultivationStage = data.cultivationStage || '炼气初期';
                        GameState.stageProgress = data.stageProgress || 0;
                        GameState.cultivationProgress = data.cultivationProgress || 0;
                        GameState.selectedBuffs = data.selectedBuffs || [];
                        GameState.character = {...GameState.character, ...data.character};
                        GameState.monsterDefeated = data.monsterDefeated || 0;
                        GameState.gameTime = data.gameTime || 0;
                        GameState.equipment = data.equipment || GameState.equipment;
                        GameState.inventory = data.inventory || GameState.inventory;
                        GameState.autoRecycle = data.autoRecycle || GameState.autoRecycle;
                        GameState.worldBoss = data.worldBoss || GameState.worldBoss;
                        GameState.attributeCosts = data.attributeCosts || GameState.attributeCosts;
                        GameState.settings = {...GameState.settings, ...data.settings};
                        GameState.lastSaveTime = data.lastSaveTime;
                        
                        // 重新计算属性
                        calculateAttributes();
                        
                        return true;
                    } else {
                        console.log('存档版本不兼容，使用新游戏');
                    }
                }
            } catch (e) {
                console.error('加载存档失败:', e);
            }
            
            return false;
        }
        
        // 开始自动保存
        function startAutoSave() {
            if (GameState.settings.autosaveEnabled) {
                setInterval(() => {
                    saveGame();
                }, GameState.settings.saveInterval);
            }
        }
        
        // 开始游戏计时器
        function startGameTimer() {
            setInterval(() => {
                GameState.gameTime++;
                if (GameState.gameTime % 60 === 0) {
                    updateUI();
                }
            }, 1000);
        }
        
        // 格式化时间
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // 重置游戏
        function resetGame() {
            if (confirm('确定要重置游戏吗？这将清除所有进度并重新开始！')) {
                // 清除本地存储
                localStorage.removeItem('cultivation_save');
                localStorage.removeItem('cultivation_auto_recycle');
                
                // 重新加载页面
                location.reload();
            }
        }
        
        // ============================
        // 移动端导航
        // ============================
        
        function setupMobileNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const target = this.dataset.target;
                    
                    // 移除所有激活状态
                    navItems.forEach(nav => nav.classList.remove('active'));
                    
                    // 添加当前激活状态
                    this.classList.add('active');
                    
                    // 处理点击动作
                    switch(target) {
                        case 'talent-panel':
                            document.getElementById('talent-panel').style.display = 'block';
                            document.getElementById('attribute-panel').style.display = 'none';
                            break;
                        case 'attribute-panel':
                            document.getElementById('talent-panel').style.display = 'none';
                            document.getElementById('attribute-panel').style.display = 'block';
                            break;
                        case 'cultivate-btn':
                            handleCultivation();
                            break;
                        case 'monster-battle':
                            document.getElementById('monster-battle').scrollIntoView({behavior: 'smooth'});
                            break;
                        case 'worldboss-content':
                            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                            document.querySelector('[data-tab="worldboss"]').classList.add('active');
                            document.getElementById('worldboss-content').classList.add('active');
                            document.getElementById('talent-panel').style.display = 'block';
                            document.getElementById('attribute-panel').style.display = 'none';
                            break;
                    }
                });
            });
        }
        
        // ============================
        // 触摸事件处理
        // ============================
        
        function setupTouchEvents() {
            let touchStartTime = 0;
            
            // 长按事件处理
            document.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                
                const equipmentSlot = e.target.closest('.equipment-slot');
                if (equipmentSlot) {
                    const slotType = equipmentSlot.dataset.slot;
                    
                    // 设置长按定时器
                    equipmentSlot.longPressTimer = setTimeout(() => {
                        let item = null;
                        item = GameState.equipment[slotType];
                        
                        if (item && confirm(`确定脱下【${item.name}】吗？`)) {
                            unequipItem(slotType);
                        }
                    }, 1000);
                }
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                // 清除长按定时器
                const equipmentSlot = e.target.closest('.equipment-slot');
                if (equipmentSlot && equipmentSlot.longPressTimer) {
                    clearTimeout(equipmentSlot.longPressTimer);
                }
            });
            
            // 双击事件处理
            let lastTap = 0;
            document.addEventListener('touchend', function(e) {
                const inventoryItem = e.target.closest('.inventory-item');
                if (inventoryItem) {
                    const currentTime = Date.now();
                    const tapLength = currentTime - lastTap;
                    
                    if (tapLength < 300 && tapLength > 0) {
                        // 双击事件
                        const itemIndex = parseInt(inventoryItem.dataset.index);
                        const item = GameState.inventory[itemIndex];
                        
                        if (item) {
                            equipItem(itemIndex);
                        }
                    }
                    lastTap = currentTime;
                }
            });
        }
        
        // ============================
        // 初始化事件监听
        // ============================
        
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            setupMobileNavigation();
            setupTouchEvents();
            
            // 天赋选择
            document.getElementById('buff-container').addEventListener('click', (e) => {
                const buffCard = e.target.closest('.buff-card');
                if (!buffCard) return;
                
                // 锁定按钮处理
                if (e.target.closest('.lock-icon')) {
                    e.stopPropagation();
                    const index = parseInt(buffCard.dataset.index);
                    toggleBuffLock(index);
                    return;
                }
                const index = parseInt(buffCard.dataset.index);
                toggleBuffSelection(index);
            });
            
            // 刷新天赋按钮
            document.getElementById('refresh-btn').addEventListener('click', refreshBuffs);
            
            // 开始修仙按钮
            document.getElementById('start-btn').addEventListener('click', () => {
                showNotification('修仙开始', '修仙之路正式开启！祝道友早日得道成仙！');
                
                // 隐藏天赋面板，显示属性面板
                document.getElementById('talent-panel').style.display = 'none';
                document.getElementById('attribute-panel').style.display = 'block';
                
                // 启用修炼功能
                document.getElementById('cultivate-btn').disabled = false;
                
                // 开始修炼
                startCultivation();
                updateUI();
                
                // 更新导航激活状态
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.target === 'attribute-panel') {
                        item.classList.add('active');
                    }
                });
                
                // 显示重置游戏按钮
                document.getElementById('reset-game-btn-2').style.display = 'block';
            });
            
            // 闭关修炼按钮
            document.getElementById('cultivate-btn').addEventListener('click', handleCultivation);
            
            // 战斗按钮
            document.getElementById('attack-btn').addEventListener('click', () => {
                handleBattleAction('attack');
            });
            
            // 自动战斗按钮
            document.getElementById('auto-battle-btn').addEventListener('click', toggleAutoBattle);
            
            // 怪物选择
            document.getElementById('monster-selection').addEventListener('click', function(e) {
                const monsterOption = e.target.closest('.monster-option');
                if (monsterOption) {
                    // 移除其他选项的选择状态
                    document.querySelectorAll('.monster-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // 设置当前选项为选中状态
                    monsterOption.classList.add('selected');
                    
                    // 加载对应等级的怪物
                    const level = parseInt(monsterOption.dataset.level);
                    loadMonster(level);
                    document.getElementById('battle-info').innerHTML = '<div class="combo-hit">你选择了挑战' + MONSTERS_BY_LEVEL[level].name + '！</div>';
                }
            });
            
            // 属性加点
            document.querySelectorAll('.stat-card-add').forEach(btn => {
                btn.addEventListener('click', function() {
                    const attr = this.dataset.attr;
                    addAttribute(attr);
                });
            });
            
            // 属性加点面板
            document.querySelectorAll('.attribute-add').forEach(btn => {
                btn.addEventListener('click', function() {
                    const attr = this.dataset.attr;
                    addAttribute(attr);
                });
            });
            
            // 选项卡切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // 移除所有激活状态
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加当前激活状态
                    this.classList.add('active');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    // 根据标签页更新显示
                    if (tabId === 'equipment') {
                        updateInventoryDisplay();
                    }
                    else if (tabId === 'recycle') {
                        updateAutoRecycleUI();
                    }
                    else if (tabId === 'saves') {
                        updateUI();
                    }
                    else if (tabId === 'worldboss') {
                        updateWorldBossDisplay();
                    }
                });
            });
            
            // 装备栏点击
            document.getElementById('equipment-grid').addEventListener('click', (e) => {
                const equipmentSlot = e.target.closest('.equipment-slot');
                if (equipmentSlot) {
                    const slotType = equipmentSlot.dataset.slot;
                    
                    // 如果装备槽有装备，显示详情
                    const item = GameState.equipment[slotType];
                    if (item) {
                        showEquipmentDetails(item);
                    } else {
                        // 如果没有装备，显示可以穿戴的装备
                        showEquipmentDetails(null);
                    }
                }
            });
            
            // 背包物品点击
            document.getElementById('inventory-grid').addEventListener('click', (e) => {
                const inventoryItem = e.target.closest('.inventory-item');
                if (inventoryItem) {
                    const itemIndex = parseInt(inventoryItem.dataset.index);
                    
                    // 切换选中状态
                    if (GameState.selectedInventoryItem === itemIndex) {
                        GameState.selectedInventoryItem = null;
                    } else {
                        GameState.selectedInventoryItem = itemIndex;
                    }
                    
                    // 更新背包显示
                    updateInventoryDisplay();
                    
                    // 显示装备详情
                    const item = GameState.inventory[itemIndex];
                    if (item) {
                        showEquipmentDetails(item);
                    }
                }
            });
            
            // 装备栏右键点击（脱下装备）- 桌面端
            document.getElementById('equipment-grid').addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const equipmentSlot = e.target.closest('.equipment-slot');
                if (equipmentSlot) {
                    const slotType = equipmentSlot.dataset.slot;
                    
                    const item = GameState.equipment[slotType];
                    
                    if (item && confirm(`确定脱下【${item.name}】吗？`)) {
                        unequipItem(slotType);
                    }
                }
            });
            
            // 背包物品双击（穿戴装备）- 桌面端
            document.getElementById('inventory-grid').addEventListener('dblclick', (e) => {
                const inventoryItem = e.target.closest('.inventory-item');
                if (inventoryItem) {
                    const itemIndex = parseInt(inventoryItem.dataset.index);
                    const item = GameState.inventory[itemIndex];
                    
                    if (item) {
                        equipItem(itemIndex);
                    }
                }
            });
            
            // 出售装备按钮
            document.getElementById('sell-equipment-btn').addEventListener('click', sellSelectedEquipment);
            
            // 自动回收功能
            document.getElementById('manual-recycle-btn').addEventListener('click', manualRecycleBackpack);
            document.getElementById('save-settings-btn').addEventListener('click', saveAutoRecycleSettings);
            
            // 世界BOSS功能
            document.getElementById('boss-challenge-btn').addEventListener('click', challengeWorldBoss);
            document.getElementById('boss-claim-btn').addEventListener('click', claimWorldBossReward);
            
            // 存档管理功能
            document.getElementById('quick-save-btn').addEventListener('click', saveGame);
            document.getElementById('load-last-btn').addEventListener('click', () => {
                if (confirm('加载上次存档将覆盖当前进度，确定要加载吗？')) {
                    location.reload();
                }
            });
            
            // 重置游戏按钮
            document.getElementById('reset-game-btn').addEventListener('click', resetGame);
            document.getElementById('reset-game-btn-2').addEventListener('click', resetGame);
            
            // 版本显示
            document.getElementById('save-version').textContent = GameState.VERSION;
        });
    </script>
</body>
</html>